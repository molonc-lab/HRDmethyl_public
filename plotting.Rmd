---
title: "20230405_scripts_paper"
author: "lijunx"
date: "April 5, 2023"
output: html_document
---
```{r setup, include=FALSE}
library("data.table")
library("purrr")
library("tidyverse")
library("scales")
library("ComplexHeatmap")
library("rstatix")
library("ggrepel")
library("ggplot2")
library("gridExtra")
library("readxl")
library("circlize")
library("ggbeeswarm")
library("ggpubr")
source("scripts/mRNA_edgeR_support.R")

```
#function
```{r function}
percent <- function(x, digits = 2, format = "f", ...) {      # Create user-defined function
  paste0(formatC(x * 100, format = format, digits = digits, ...), "%")
}

change_facet_strip_color <- function(ggplot, color_list){
  plot_gtable <- ggplot_gtable(ggplot_build(ggplot))
  stripr <-  which(grepl('strip-t',plot_gtable$layout$name))
  fills <- color_list
  k <- 1
 for (i in stripr) {
    j <- which(grepl('rect', plot_gtable$grobs[[i]]$grobs[[1]]$childrenOrder))
    plot_gtable$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
    k <- k+1
 }
  return(plot_gtable)
}

```
#palette
```{r}
methylation_color = c("BRCA1 & RAD51C" = "#46351D","BRCA1" = "#93a667", "RAD51C" = "#7BB2D9", "No" = "grey")
methylation_color_extended= c("BRCA1" = "#93a667", "RAD51C" = "#7BB2D9", "No" = "grey",
                              "BRCA2" = "#FAA613", "PALB2" = "#D90368", "BRIP1" = "#4F4789")
methylation_color_ht = c("BRCA1 & RAD51C" = "#46351D","BRCA1" = "#93a667", "RAD51C" = "#7BB2D9", "No" = "white")
methylation_color_brca1 = c("Yes" = "#93a667","No" = alpha("grey", 0.6))
methylation_color_rad51c = c("Yes" = "#7BB2D9","No" = alpha("grey", 0.6))
col = list(alt = c("MUT" = "#EE8A8A", "Conseq" = "#616161", "NA" = "white"),
           Methylation = methylation_color,
          CIMP = c("CIMP-" = "#D6F8D6", "CIMP+" = "#7FC6A4", "CIMPi" = "#B0C7BD", "NA" = "white"),
           `CpG Methylation` = c("Low" = "#D6F8D6", "High" = "#7FC6A4", "Intermediate" = "#B0C7BD", "NA" = "white"),
           `STAD Subtype` = c("EBV" = "#CB6434", "CIN" = "#E09A75", "MSI" = "#F5CFB5", "NA" = "white"),
           `LGG Subtype` = c("IDHmut codel" = "#BB9F23", "IDHmut non-codel" = "#DDCE74", "IDHwt" = "#FFFCC5", "NA" = "white"),
           `UCEC Subtype` = c("CN HIGH" = "#3F72AF", "MSI" = "#90caf9", "NA" = "white"),
           `TGCT Subtype` = c("Mixed Germ Cell Tumor" = "#DC778D", "Yolk Sac Tumor" = "#E4B1BC","NA" = "white"),
           `BC Subtype` = c("LumA" = "#AAA1C8", "LumB" = "#D5C6E0", "Basal" = "#192A51", "Normal" ="#F5E6E8" , "Her2" = "#967AA1", "NA" = "white"),
           Meth_lvl = c("HM"= "#F9A620","LM"= "#F8DD83","NA" = "white"))

col_sig = list(Methylation = c("BRCA1 & RAD51C" = "#46351D","BRCA1" = "#93a667", "RAD51C" = "#7BB2D9", "No" = "white"))

methylation_lvl <- c("BRCA1 & RAD51C","BRCA1", "RAD51C", "No")
project_lvl <- c("OV", "TGCT", "STAD","LGG","BC", "UCEC", "LIHC", "COAD", "LUSC", "HNSC", "THCA")
hr_gene_list <- c("BRCA1", "BRCA2", "RAD51C", "PALB2", "BRIP1", "RAD51D")

RAD51C_het_hom <- c("Homozygous RAD51Cme" =  "#165E91", "Heterozygous RAD51Cme" = "#7BB2DA", "No Methylation" =  "grey")

HRD_color <- colorRamp2(breaks = c(0, 42, 100), colors = c("#AEB6E5", "white", "#A93154"))
prom_meth_color <- colorRamp2(breaks = c(0, 0.5, 1), colors = c("#5D3A9B", "white", "#E66100"))
avg_corr_meth_color <- colorRamp2(breaks = c(0, 0.5, 1), colors = c("#0C7BDC", "white", "#FFC20A"))
signature_color <- colorRamp2(breaks = c(0,0.1, 1), colors = c("white","#F1F1F1", "#26A63A"))
Purity = colorRamp2(breaks = c(0, 0.5, 1), colors = c("white", "grey", "black"))
 `CN` =colorRamp2(breaks = c(0, 2, 8), colors = c("#4D7C93", "white", "#CC5C3E"))
 
 alter_fun = list(
    background = function(x, y, w, h) {
        grid.rect(x, y, w-unit(2, "pt"), h-unit(2, "pt"),
            gp = gpar(fill = "#EBEBEB", col = NA))
    },
    `NA` = function(x, y, w, h) {
        grid.rect(x, y, w-unit(2, "pt"), h-unit(2, "pt"),
            gp = gpar(fill = "white", col = NA))
    },
    `Nonsense` = function(x, y, w, h) {
        grid.rect(x, y, w-unit(2, "pt"), h-unit(2, "pt"),
            gp = gpar(fill =  "#8B7774", col = NA))
    },
    `Frameshift` = function(x, y, w, h) {
        grid.rect(x, y, w-unit(2, "pt"), h-unit(2, "pt"),
            gp = gpar(fill =  "#C17767", col = NA))
    },
    `Splice Site` = function(x, y, w, h) {
        grid.rect(x, y, w-unit(2, "pt"), h-unit(2, "pt"),
            gp = gpar(fill =  "#E4924E", col = NA))
    },
   `In Frame`= function(x, y, w, h) {
        grid.rect(x, y, w-unit(2, "pt"), h-unit(2, "pt"),
            gp = gpar(fill =  "#EDD382", col = NA))
    },
   `Missense`= function(x, y, w, h) {
        grid.rect(x, y, w-unit(2, "pt"), h-unit(2, "pt"),
            gp = gpar(fill =  "#719DB1", col = NA))
    },
    `ClinVar P/LP` = function(x, y, w, h) {
        grid.roundrect(x, y, w-unit(2, "pt"), h*0.1,
            gp = gpar(fill = "#616161", col = NA))
    }
)

```

#load data
```{r load data}
primary_tumour_ICGC <- fread("data/raw/20220505_ICGC_OV_meth/icgc_sample_id_mapping.tsv") %>%
               filter(`Sample time point` == "primary") %>%
               mutate(Sample.ID_merge = gsub("_","", paste0(`Case ID`, `Tumour sample ID`))) 
# beta
Deduplicated_beta <- map_dfr(Sys.glob("data/processed/methylation/*deduplicated_sample.csv"),
                             ~ fread(.x, header = T, na.strings = "", fill = T) %>%
  mutate(Project = gsub("_deduplicated_sample.csv", "", basename(.x)),
  Sample_Group = gsub("Tumour", "Tumor", Sample_Group)))

#mRNA
mRNA_sample <- map_dfr(Sys.glob("data/raw/*/mRNA/TCGA_*_sample.tsv"),
                       ~ fread(.x, header = T)) %>%
  filter(`Sample Type` == "Primary Tumor")%>%
  mutate(File.Name = gsub("-", ".",gsub(".rna_seq.augmented_star_gene_counts.tsv", "", `File Name`))) %>%
  dplyr::select(File.Name, Sample.ID= `Sample ID`, Project = `Project ID`, Sample_Group = `Sample Type`)

mRNA_sample_ICGC <- fread(Sys.glob("data/raw/*/mRNA/ICGC*_sample.csv")) %>%
  filter(SampleType == "Primary tumour") %>%
  mutate(File.Name = paste( gsub("-", ".", sampleLabel), gsub("-", ".", donorLabel), sep = "_"),
         Sample_Group = "Primary Tumor",
         Sample.ID = paste( gsub("-", "_", donorLabel), gsub("-", "_", sampleLabel), sep = "_"), 
         Project = "OV") %>%
  dplyr::select(File.Name, Sample.ID, Project, Sample_Group )

mRNA <- map_dfr(Sys.glob("data/processed/mRNA/*_mRNA_edgeR.csv"), ~as.data.frame(t(data.frame(data.table::fread(.x, header = T, na.string = "", fill = T), row.names = 1))))%>%
  mutate(File.Name = gsub(".rna_seq.augmented_star_gene_counts.tsv", "", gsub("^X", "", rownames(.))),
          File.Name = case_when(str_detect(File.Name, "TR_AOCS") ~ vapply(strsplit(File.Name, "\\."), function(x) paste(x[seq.int(6)], collapse='.'), character(1L)),
            (startsWith( File.Name, "ICGC")|startsWith( File.Name, "EXTERN"))~ vapply(strsplit(File.Name, "\\."), function(x) paste(x[seq.int(5)], collapse='.'), character(1L)),
            TRUE~ File.Name))%>%
  left_join(rbind(mRNA_sample, mRNA_sample_ICGC) , by = "File.Name")

#copy number 
copy_number_sample <- map_dfr(Sys.glob("data/raw/*/copynumber/TCGA_*cn_sample.tsv"),
                       ~ fread(.x, header = T)) %>%
  filter(str_detect(`Sample Type`, "Primary Tumor"))
copy_number_sample$`Case ID` <- unlist(lapply(copy_number_sample$`Case ID`, function(x) unique(unlist(strsplit(x, split = ", ")))))

copy_number_sample_ICGC <- fread(Sys.glob("data/processed/copynumber/ICGC_*cnv.tsv"), header =F) %>%
 separate(V1, into= c("Sample.ID"), extra = "drop", sep = "\\.") %>%
  mutate(Sample.ID_merge = gsub("-","",gsub("_", "", Sample.ID))) %>%
  right_join(primary_tumour_ICGC %>%
               dplyr::select(Sample.ID_merge)) %>%
  filter(!is.na(Sample.ID)) %>%
  mutate(Patient.ID = gsub("-", "_",substr(Sample.ID, 1, 8)))

# mutation
maf_sample <- map_dfr(Sys.glob("data/raw/*/MAF/TCGA_*maf_sample.tsv"),
                       ~ fread(.x, header = T)) %>%
  filter(str_detect(`Sample Type`, "Primary Tumor"))
maf_sample$`Case ID` <- unlist(lapply(maf_sample$`Case ID`, function(x) unique(unlist(strsplit(x, split = ", ")))))

maf_sample_ICGC <- unlist(lapply(Sys.glob("data/raw/20220505_ICGC_OV_meth/MAFs/*.shc.maf.gz"), function(x) gsub("-", "",paste0(unlist(strsplit(x, split = "\\."))[1:2], collapse = "")))) %>%
  as.data.frame() %>%
  dplyr::select(Sample.ID_merge = 1) %>%
  right_join(primary_tumour_ICGC %>%
               dplyr::select(`Case ID`, Sample.ID_merge))




#methylation values
beta_sub <- map_dfr(Sys.glob("data/processed/methylation/*_beta_subset_promo.csv"), ~ as.data.frame(data.table::fread(.x, header = T, na.strings = "", fill = T,  colClasses = c("Sentrix_ID"= "character")))) %>%
    filter(startsWith(Project, "TCGA")| startsWith(Project, "ICGC")) %>%
    dplyr::select(-c("Sample_Plate","Pool_ID", "Sample_Well", "Sentrix_ID","Sentrix_Position"))
beta_sub <- beta_sub%>%
    mutate(Sample_Group = gsub("Tumour", "Tumor", Sample_Group),
           Project = gsub("ICGC_|TCGA_", "", Project),
           Project = if_else(Project == "BRCA", "BC", Project))

beta_sub_meth <- BRCA1_RAD51C_meth_annotat(beta_sub %>%
                                            distinct())
beta_sub_meth_t <- beta_sub_meth %>%
  filter(Sample_Group =="Primary Tumor", Sample_Name %in% Deduplicated_beta$Sample_Name) %>%
  pivot_longer(cols=c("BRCA1_M", "RAD51C_M"), values_to = "Methylation", names_to = "gene2") %>%
  mutate(gene2 = gsub("_M","", gene2)) %>%
  filter(gene == gene2) %>%
  dplyr::select(-c("gene2"))%>%
  dplyr::select(gene, Project, Methylation, Sample.ID) %>%
  distinct()

```
##expression
```{r}
#mRNA
beta_sub_meth_mrna_t <- beta_sub_meth_t %>%
  left_join(mRNA %>% filter(Project != "OV") %>%
              dplyr::select(BRCA1 = ENSG00000012048.23, 
                RAD51C = ENSG00000108384.15,Sample.ID)) %>%
  pivot_longer(cols = c("BRCA1","RAD51C"), names_to = "mRNA_gene", values_to ="mRNA_norm_counts") %>%
  filter(gene == mRNA_gene) %>%
  dplyr::select(-mRNA_gene) %>%
  mutate(caseID = if_else(Project =="OV", substr(Sample.ID, 1, 8), Sample.ID)) %>%
  left_join(mRNA%>% filter(Project == "OV") %>%
              mutate(Sample.ID = substr(Sample.ID, 1, 8)) %>%
              dplyr::select(caseID = Sample.ID, BRCA1= ENSG00000012048, RAD51C = ENSG00000108384), by = c("caseID")) %>%
  pivot_longer(cols = c("BRCA1","RAD51C"), names_to = "mRNA_gene", values_to ="mRNA_norm_counts_icgc") %>%
  filter(gene == mRNA_gene) %>%
  mutate(mRNA_norm_counts = if_else(Project == "OV", mRNA_norm_counts_icgc, mRNA_norm_counts)) %>%
  dplyr::select(-c("mRNA_gene", "mRNA_norm_counts_icgc", "caseID")) 
```
##demographic
```{r}
beta_sub_pd <- map_dfr(Sys.glob("data/raw/*/IDAT/*pd.csv"), ~ as.data.frame(fread(.x, header = T, na.strings = "", fill = T,  colClasses = c("Sentrix_ID"= "character")))) %>%
  filter((startsWith(Project, "TCGA")| startsWith(Project, "ICGC")), Sample_Name %in% Deduplicated_beta$Sample_Name) %>%
  dplyr::select(-c("Sample_Plate","Pool_ID", "Sample_Well", "Sentrix_ID","Sentrix_Position"))

Sample_number <- beta_sub_pd %>% 
  dplyr::select(Project, Sample_Name, Sample_Group) %>%
        distinct() %>%
        group_by(Project, Sample_Group) %>%
        summarise(pre_filer=n()) %>%
  ungroup()

Deduplicated_beta %>%
  filter(Sample_Group %in% c("Primary Tumor"), Sample_Name %in% Deduplicated_beta$Sample_Name) %>%
  dplyr::select(Project, Sample_Name, Sample_Group, Sample.ID) %>%
        distinct() %>%
   mutate( Sample_Group = gsub("Tumour", "Tumor", Sample_Group),
           CaseID = if_else(Project =="ICGC_OV", substr(start = 1,stop = 8, Sample.ID), substr(start = 1,stop = 12, Sample.ID) )) %>%
  left_join( rbind(map_dfr(Sys.glob("data/raw/*/*clinical.tsv"), ~ as.data.frame(fread(.x, header = T, na.strings = "'--", fill = T,  colClasses = "character"))) %>%
               mutate(age = as.numeric(age_at_index)) %>%
                dplyr::select(stage = ajcc_pathologic_stage, gender, race, age, CaseID=case_submitter_id),
 fread("/working/lab_nicw/lijunX/20220505_ICGC_OV_meth/Patch_2015_ICGC_donor.tsv") %>%
  mutate(CaseID = gsub("-", "_", submitted_donor_id,),
         race = "not reported",
         stage = paste("Stage", donor_tumour_stage_at_diagnosis, sep = " ")) %>%
  dplyr::select(stage, gender= donor_sex, race, age = donor_age_at_diagnosis, CaseID)), by = "CaseID")%>%
  mutate(race = if_else(Project == "ICGC_OV", "not reported", race),
         stage = if_else(is.na(stage), "not reported", stage)) %>%
    distinct()-> demograph_table

demograph_table<- demograph_table %>%
  mutate(Project = gsub("ICGC_|TCGA_", "", Project),
         Project = if_else(Project == "BRCA", "BC", Project),
         sex = case_when(is.na(gender) & Project == "TCGA_TGCT" ~"M",
                            is.na(gender) ~ "not reported",
                            gender == "female" ~ "F",
                            gender == "male" ~ "M")) %>%
  dplyr::rename(Dataset = Project)
consensus_ethnicity <- read_xlsx("data/supporting/Carrot_Zhang_J_Cancer_Cell_2020_supp_10AUG23.xlsx", skip = 1)

demograph_table %>%
  left_join(beta_sub_meth_t %>%
              filter(Methylation != "No") %>%
              dplyr::select(gene, Methylation, Sample.ID))  %>%
  group_by(Sample.ID) %>%
  mutate(Methylation = paste(gene, collapse = " & "),
         Methylation = if_else(Methylation == "NA", "No", Methylation),
         Methylation = factor(Methylation, levels= c("BRCA1", "RAD51C", "BRCA1 & RAD51C", "No")), 
         sex = case_when(is.na(gender) & Dataset == "TGCT" ~"M",
                            is.na(gender) ~ "NA",
                            gender == "female" ~ "F",
                            gender == "male" ~ "M"),
         stage = if_else(stage %in% c("not reported", "Not Reported"), "NA", stage))%>%
  left_join(consensus_ethnicity %>%
              dplyr::select(CaseID = patient, `consensus_ancestry`)) %>%
  mutate(consensus_ancestry = if_else(is.na(consensus_ancestry), "NA", consensus_ancestry)) %>%
  dplyr::select(Dataset, DonorID = CaseID, SampleID = Sample.ID, Sample_Group, age, sex, consensus_ancestry, stage, Methylation) %>%
  distinct() -> demograph_table_meth


```

## mutation
```{r}
oncokb_gene_list <- fread("data/supporting/cancerGeneList_ONCOKB_ver_20230412.tsv")
gene_list = c("TP53", "PIK3CA", "IDH1", "ARID1A", "PTEN", "NUMA1", "CIC")


#TCGA SOMATIC
mc3 <- as.data.frame(fread("data/raw/mc3.v0.2.8.PUBLIC.maf", showProgres = T))
mc3 <- mc3 %>%
  mutate(silent_mutation = if_else(Variant_Classification %in% c("3'Flank", "5'Flank","3'UTR", "5'UTR","RNA", "Intron", "Silent"), "Yes", "No"))

#ICGC SOMATIC
mutation_icgc <- Sys.glob("/working/genomeinfo/share/analysis/AOCS_-_ICGC_ovarian_cancer_project/MAFs/*shc.maf.gz") %>%
  map_dfr(~fread(cmd = paste0("gunzip -cq ", .x), skip = "Hugo_Symbol") %>%
            mutate(Sample.ID =.x) %>%
            filter(Hugo_Symbol != "unknown") %>%
  separate(Tumor_Sample_Barcode, into = c("id_1", "id_2"), extra = "drop", sep = ":") %>%
  mutate(Sample.ID = gsub("-", "_",paste(id_1, id_2, sep = "-")) ))%>%
  mutate(silent_mutation = if_else((Effect_Ontology %in% 
                                     c("5_prime_UTR_variant", "3_prime_UTR_variant", "synonymous_variant", "intron_variant", "intergenic_region") |
                                       Variant_Classification %in% c("3'Flank", "5'Flank")), "Yes", "No"))

#MERGE ICGC & TCGA 
mc3_icgc <- rbind(mutation_icgc %>%
                    dplyr::select(Hugo_Symbol, Sample.ID, silent_mutation),
                  mc3 %>% 
                    mutate(Sample.ID = substr(Tumor_Sample_Barcode, 1, 15)) %>%
                    dplyr::select(Hugo_Symbol, Sample.ID, silent_mutation))

#VEP ANNOTATED WITH CLINICAL 
TP53_CLINVAR <- as.data.frame(fread("data/processed/VCF/variants_hg19.vep102.tsv",skip = "#Up", header = T, sep = "\t", na.strings = c("-")))
TP53_CLINVAR <- TP53_CLINVAR[, colSums(is.na(TP53_CLINVAR)) != nrow(TP53_CLINVAR)]
TP53_CLINVAR <- TP53_CLINVAR %>%
  filter(SYMBOL %in% gene_list ) %>%
  dplyr::select(`#Uploaded_variation`, Location, Gene, Consequence,IMPACT, VARIANT_CLASS, SYMBOL, CANONICAL, EXON, HGVSc, HGVSp, ClinVar_CLNREVSTAT, ClinVar_CLNSIG)

TP53_CLINVAR <- TP53_CLINVAR %>%
  mutate(customised_function_loss = case_when(
    str_detect(ClinVar_CLNSIG, fixed("benign", ignore_case = T)) ~ "No",
    ClinVar_CLNREVSTAT %in% c("reviewed_by_expert_panel", "criteria_provided,_single_submitter", "criteria_provided,_multiple_submitters,_no_conflicts") & str_detect(ClinVar_CLNSIG, fixed("pathogenic", ignore_case = T)) ~ "Yes",
    (as.numeric(unlist(strsplit(EXON, "/"))[1]) < as.numeric(unlist(strsplit(EXON, "/"))[2])) & str_detect(Consequence, "stop_gained|frameshift") ~ "Yes",
    str_detect(Consequence,"splice_acceptor_variant|splice_donor_variant")  ~ "Yes",
    str_detect(Consequence, "start_lost") ~ "Yes",
   TRUE ~ "No")) %>%
  distinct() %>%
  mutate(HGVSc = sapply(str_split(.$HGVSc, ":"), function(x) x[2]),HGVSp = sapply(str_split(.$HGVSp, ":"), function(x) x[2])) 

mc3_gene <- rbind(mc3 %>%
                    mutate(Alt = if_else(Tumor_Seq_Allele1 ==Reference_Allele, Tumor_Seq_Allele2, Tumor_Seq_Allele1)) %>%
  dplyr::select(Hugo_Symbol, Tumor_Sample_Barcode, HGVSc, HGVSp, silent_mutation, Chromosome, Start_Position, Ref = Reference_Allele, Alt, Variant_Classification),
  mutation_icgc %>%
    mutate(Alt = if_else(Tumor_Seq_Allele1 ==Reference_Allele, Tumor_Seq_Allele2, Tumor_Seq_Allele1))%>%
    dplyr::select(Hugo_Symbol, Tumor_Sample_Barcode= Sample.ID, HGVSc = CDS_Change, HGVSp =Amino_Acid_Change, silent_mutation, Chromosome, Start_Position, Ref = Reference_Allele, Alt, Variant_Classification)) %>%
  mutate(Sample.ID = if_else(startsWith(Tumor_Sample_Barcode, "AOC"), substr(Tumor_Sample_Barcode, 1, 27), substr(Tumor_Sample_Barcode, 1, 15)))%>%
  filter(Hugo_Symbol %in% c(gene_list,"TP53", "BRCA1", "BRCA2", "CDK12", "RAD51C", "PALB2", "BRIP1", "RAD51D")) %>%
  dplyr::select(-Tumor_Sample_Barcode) %>%
  distinct() %>%
  mutate(`#Uploaded_variation` = paste0(Chromosome, "_", Start_Position,"_", Ref, "/", Alt)) %>%
  dplyr::select(-Chromosome, -Start_Position, -Ref, -Alt) %>%
  left_join(TP53_CLINVAR %>%
              dplyr::rename(Hugo_Symbol =SYMBOL)) %>%
  filter(silent_mutation != "Yes") %>%
  mutate(Variant_Classification = case_when(`#Uploaded_variation` == "17_7576525_A/C" ~ "Splice_Site",
                                            TRUE ~Variant_Classification) )


 mc3_gene %<>%
  mutate(Mutation_Type = case_when(str_detect( Variant_Classification, "Frame_Shift") ~ "Frameshift",
                                   str_detect( Variant_Classification, "Splice") ~ "Splice Site",
                                   str_detect( Variant_Classification, "Nonsense") ~ "Nonsense",
                                   str_detect( Variant_Classification, "Start") ~ "Start Site",
                                   str_detect( Variant_Classification, "Missense") ~ "Missense",
                                   str_detect( Variant_Classification, "In_Frame") ~ "In Frame",
                                   str_detect( Variant_Classification, "Nonstop") ~ "Nonstop",
                                   TRUE ~ Variant_Classification)) %>%
  # dplyr::select(Hugo_Symbol, Sample.ID, ClinVar_CLNSIG, customised_function_loss, Mutation_Type, IMPACT, `#Uploaded_variation`) %>%
  distinct() %>%
  mutate(IMPACT = factor(IMPACT, levels = c("HIGH", "MODERATE")),
         customised_function_loss = factor(customised_function_loss, levels = c("Yes", "No")),
         Mutation_Type = factor(Mutation_Type, levels = c( "Frameshift", "Nonsense", "Start Site","Splice Site", "Nonstop", "In Frame", "Missense"))
         ) %>%
  group_by(Sample.ID, Hugo_Symbol) %>%
  slice(1) %>%
  ungroup()%>%
  mutate(Mutation_Type= if_else(!is.na(ClinVar_CLNSIG) & str_detect(ClinVar_CLNSIG, fixed( "path", ignore_case =T)) 
                                & !str_detect(ClinVar_CLNSIG, fixed( "conflicting", ignore_case =T)),
                                paste(Mutation_Type, "ClinVar P/LP", sep = ";"), Mutation_Type)) %>%
  dplyr::select(Sample.ID, Hugo_Symbol, Mutation_Type) %>%
  pivot_wider(names_from = Hugo_Symbol, values_from = Mutation_Type)
# for(gene in  c(gene_list,"TP53", "BRCA1", "BRCA2", "CDK12", "RAD51C", "PALB2", "BRIP1", "RAD51D")){
#   clinical = paste0(gene, "_clinical")
#   mc3_gene <- mc3_gene %>%
#     group_by(Sample.ID)%>%
#     mutate(!!gene := case_when(any(Hugo_Symbol == gene & 
#                    (HGVSc %in% unlist(TP53_CLINVAR[which(TP53_CLINVAR$SYMBOL == gene), "HGVSc"]) |
#                       HGVSp %in% unlist(TP53_CLINVAR[which(TP53_CLINVAR$SYMBOL == gene), "HGVSp"]))) ~ "MUT;Conseq", 
#                    any(Hugo_Symbol == gene & silent_mutation == "No") ~ "MUT",
#                    TRUE ~ ""))
# }

```
##purity
```{r}
absolute_purity <- fread("data/processed/TCGA_ABSOLUTE_purity.txt")%>%
  mutate(Sample.ID = array) %>%
  dplyr::rename(absolute_purity = purity) %>%
  dplyr::select(Sample.ID, absolute_purity)

#assess for duplication
absolute_purity %>%
  # filter(startsWith(Sample.ID, "TCGA")) %>%
  group_by(Sample.ID) %>%
   filter(n() >1)

ov_purity <- fread("data/processed/ICGC_OV_purity.csv")%>%
  `colnames<-`(c("Sample_Name", "ascat_purity"))%>%
    mutate(Sample_Name = gsub("-", "_", Sample_Name))

purity <- rbind(absolute_purity %>% dplyr::select(Sample.ID, purity = absolute_purity),
                ov_purity%>% dplyr::select(Sample.ID = Sample_Name, purity = ascat_purity))

```
##CN
```{r}
cnv <- Sys.glob("data/processed/copynumber/TCGA*cnv.tsv") %>%
  map_dfr(~ as.data.frame(fread(.x, header = F, na.string = "", fill = T))) %>%
  mutate(V1 = basename(V1)) %>%
  separate(V1, into = c("File Name", "transcript"), sep = ":")

cnv_sample <- Sys.glob("data/raw/*/copynumber/TCGA_*_cn_sample.tsv")%>%
  map_dfr( ~data.table::fread(.x)) %>%
  separate_rows(`Case ID`, `Sample ID`, `Sample Type`, sep = ", ")


TCGA_cn <- cnv_sample %>%
  dplyr::select(`File Name`, Sample.ID = `Sample ID`) %>%
  left_join(cnv %>%
              dplyr::select(`File Name`, gene = V2,CN = V6)) %>%
  dplyr::select( Sample.ID, gene, CN)

ICGC_cn <- fread("data/processed/copynumber/ICGC_OV_BRCA1_RAD51C_cnv.tsv") %>%
  separate(V1, into = c("CaseID", "Sample_Name"), sep = "_", extra = "drop") %>%
  separate(Sample_Name, into = c("Sample_Name"), sep = "\\.", extra = "drop") %>%
  mutate(Sample.ID  = paste(gsub("-", "_", CaseID),gsub("-", "_", Sample_Name),sep = "_")) %>%
  dplyr::select(Sample.ID, gene = V2, CN = V6)

  
```
## corrected Beta
```{r}
cn_purity <- beta_sub %>%
  filter(Sample_Name %in% Deduplicated_beta$Sample_Name) %>%
   left_join(rbind(ICGC_cn, TCGA_cn) , by = c("Sample.ID","gene")) %>%
  mutate(Sample.ID_original = if_else(Project =="OV", Sample.ID,substr(Sample.ID, 1, 15)),
    Sample.ID = if_else(Project =="OV", substr(Sample.ID, 1, 27),substr(Sample.ID, 1, 15))) %>%
  left_join(purity, by = c("Sample.ID_original" = "Sample.ID")) %>%
  filter(!is.na(PredefinedCpG), Sample_Group %in% c("Primary Tumor", "Solid Tissue Normal")) %>%
  dplyr::select(gene, chr_start, CpG, distToTSS, CpG_context, Sample_Name, beta, Sample_Group, Project, Sample.ID,PredefinedCpG, CN, Sample.ID_original, purity)


mean_norm_meth <- cn_purity %>%
  filter(str_detect(Sample_Group, regex('normal', ignore_case = T))) %>%
  group_by(Project, CpG) %>%
  summarise(mean_non_meth_beta = mean(beta)) 
mean_norm_meth <-  bind_rows(mean_norm_meth, mean_norm_meth %>%
             filter(Project == "GBM") %>%
  mutate(Project = "LGG"))


cn_purity_adj_beta <- cn_purity %>%
  left_join(mean_norm_meth, by = c("Project", "CpG") )%>%
   mutate(mt = ((beta * (purity * CN + 2 * (1 - purity)) - 2 * mean_non_meth_beta * (1- purity)))/ (purity * CN))%>%
  mutate(mt = ifelse(CN ==0, 0, mt),
    mt_cap = case_when(mt >1 ~ 1,
                        mt <0 ~ 0,
                        TRUE ~ mt)) %>%
  mutate(CpG = factor(CpG, levels = unique(beta_sub$CpG[order(beta_sub$chr_start)])))
```
##Molecular Subtype
```{r molecular subtype}
TCGA_subtype_info <- Sys.glob("data/supporting/*tcga_pan_can_atlas_2018_clinical*") %>%
  map_dfr(~ as.data.frame(fread(.x)))

cimp_label <-as.data.frame(fread("data/supporting/methylation_cluster_membership_all_TCGA.csv", header= T)) %>%
  mutate(Sample.ID= substr(id, 1, 15)) %>%
  dplyr::select(Sample.ID,Cluster)

ICGC_subtype_info <- read_excel("data/supporting/nature14410-Supplementary Table 13.xlsx", sheet = 2, skip = 2) %>%
  dplyr::select(SampleID, group = `HRD/CCNE1/WT Group`)
  
TGCT_cimp_label <- fread("data/processed/methylation_clustering/TGCT_cluster_memb_new.csv") %>%
  mutate(cluster = case_when(cluster ==1 ~ "High meth cluster",
                             cluster ==2 ~ "Low meth cluster")) %>%
  dplyr::select(Sample_Name = index,Cluster = cluster) %>%
  left_join(Deduplicated_beta %>%
              filter(Sample_Group == "Primary Tumor", Project == "TCGA_TGCT") %>%
              dplyr::select(Sample_Name, Sample.ID)) %>%
  mutate(Sample.ID = substr(Sample.ID, 1, 15)) %>%
  dplyr::select(Sample.ID, Cluster)
  
cimp_label_icgc <- as.data.frame(fread("data/processed/methylation_clustering/OV_cluster_memb_new.csv")) %>%
  mutate(cluster = case_when(cluster ==1 ~ "High meth cluster",
                             cluster ==2 ~ "Low meth cluster")) %>%
  dplyr::select(Sample_Name = index,Cluster = cluster) %>%
  inner_join(beta_sub_meth %>%
              filter(Project == "OV") %>%
              dplyr::select(Sample_Name, Sample.ID) %>%
               distinct()) %>%
  dplyr::select(Sample.ID,Cluster)
histo_label <- as.data.frame(fread("data/supporting/TCGA_BRCA_histo_annotation.csv" ,header = T, na.strings = "N/A", fill = F))
colnames(histo_label) <- make.names(colnames(histo_label))

breast_idh <-  TCGA_subtype_info %>%
  separate(Subtype, into =c("Project", "Molecular_Subtype"), sep = "_", extra = "merge") %>%
  filter(str_detect(`Cancer Type Detailed`,"Breast")) %>%
  left_join(histo_label %>% 
              filter(Tumor.or.Normal == "Tumor") %>%
              mutate(CLID = substr(CLID, 1,15),
                     er_pr = case_when(er_status_by_ihc =="Positive" | pr_status_by_ihc =="Positive" ~ "ER/PR+",
                                       er_status_by_ihc %in% c("Indeterminate", "[Not Evaluated]") | pr_status_by_ihc %in% c("Indeterminate", "[Not Evaluated]") ~ "NA",
                                    TRUE ~ "ER/PR-"),
                     HER2.newly.derived = case_when(HER2.newly.derived =="Positive" ~ "HER2+",
                                                           HER2.newly.derived == "Negative" ~ "HER2-",
                                                     TRUE ~ "NA"),
                     Triple.Negative.Status = case_when(Triple.Negative.Status == "Yes" ~"TN",
                                                        Triple.Negative.Status == "No" &  HER2.newly.derived !="NA" & er_pr != "NA" ~ paste0(er_pr, ";",HER2.newly.derived ),
                                                        Triple.Negative.Status == "No" & HER2.newly.derived == "NA" & er_pr != "NA" ~
                                                         "NA",
                                                        TRUE ~"NA"))%>%
              dplyr::select(`Sample ID` = CLID, PAM50 = starts_with("PAM"), Triple.Negative.Status)) %>%
  mutate(Subtype = if_else(!is.na(Triple.Negative.Status), PAM50, Molecular_Subtype),
         `Cancer Type Detailed` = if_else(`Sample ID` %in% unlist(substr(histo_label$CLID, 1,15)), Triple.Negative.Status, `Cancer Type Detailed`)) %>%
  dplyr::select(- Triple.Negative.Status,-PAM50, -Molecular_Subtype, -Project, -`Patient ID`) 



TCGA_subtype_info <- TCGA_subtype_info %>%
  separate(Subtype, into =c("Project", "Molecular_Subtype"), sep = "_", extra = "merge") %>%
  mutate(`Cancer Type Detailed` = case_when( startsWith(`Cancer Type Detailed`, "Signet Ring Cell") ~"Signet Ring Cell",
                                            `Cancer Type Detailed` == "Stomach Adenocarcinoma" ~"NOS",
                                            str_detect(`Cancer Type Detailed`,"NOS")~ "NOS",
                                            str_detect(`Cancer Type Detailed`,"Stomach")~ gsub("Stomach Adenocarcinoma", "", `Cancer Type Detailed`),
                                            `Cancer Type Detailed` == "Invasive Breast Carcinoma" ~"NOS",
                                            str_detect(`Cancer Type Detailed`,"Breast")~ gsub("Carcinoma", "", gsub("Breast Invasive", "", `Cancer Type Detailed`)),
                                            TRUE ~`Cancer Type Detailed`),
        Molecular_Subtype = case_when(Project == "LGG" & Molecular_Subtype == "IDHmut-non-codel" ~ "IDHmut non-codel",
                                      Project == "LGG" & Molecular_Subtype == "IDHmut-codel" ~ "IDHmut codel",
                                      Project == "UCEC" ~ gsub("_", " ",Molecular_Subtype),
                                      TRUE ~ Molecular_Subtype))%>%
  left_join(histo_label %>% 
              filter(Tumor.or.Normal == "Tumor") %>%
              mutate(CLID = substr(CLID, 1,15))%>%
              dplyr::select(`Sample ID` = CLID, PAM50 = starts_with("PAM"))) %>%
  mutate(Subtype = if_else( str_detect(`Cancer Type Detailed`,"Breast"), PAM50, Molecular_Subtype))%>%
  dplyr::select(-PAM50, -Molecular_Subtype, -Project, -`Patient ID`) %>%
  dplyr::rename(Sample.ID = `Sample ID`, MSI_Score = `MSIsensor Score`, Aneuploidy_Score = `Aneuploidy Score`, TMB_nonsilent = `TMB (nonsynonymous)`) 


TCGA_subtype_complete <- beta_sub_meth_t %>%
  mutate(Methylation= if_else(Methylation == "No", Methylation, gene)) %>%
  dplyr::select(-gene) %>%
  distinct() %>%
  group_by(Project, Sample.ID) %>%
  mutate(methylation_coexit = sum(Methylation != "No")) %>%
  mutate(Methylation = if_else(methylation_coexit >1 , "BRCA1 & RAD51C", Methylation)) %>%
  distinct() %>%
  filter((methylation_coexit != 1) |(methylation_coexit ==1 & Methylation != "No")) %>%
  ungroup() %>%
  dplyr::select(-methylation_coexit) %>%
  mutate(Sample.ID = if_else(startsWith(Sample.ID, "AOC"), Sample.ID, substr(Sample.ID, 1, 15))) %>%
  left_join(rbind(cimp_label, TGCT_cimp_label,cimp_label_icgc)) %>%
  mutate(cimp_label = case_when(Cluster == "High meth cluster" ~ "CIMP+",
                                Cluster == "Intermediate meth cluster" ~ "CIMPi",
                                Cluster == "Low meth cluster" ~ "CIMP-")) %>%
  mutate(Sample.ID_original = Sample.ID) %>%
  mutate(Sample.ID = if_else(Project =="OV", substr(Sample.ID, 1, 27), Sample.ID)) %>%
  left_join(mc3_gene %>%
              ungroup() %>%
              distinct() %>%
              mutate(Sample.ID = if_else(startsWith(Sample.ID, "AOC"), substr(Sample.ID, 1, 27), Sample.ID))) %>%
  distinct() %>%
  left_join(TCGA_subtype_info) %>%
  mutate(SampleID = substr(Sample.ID, 1, 8)) %>%
  left_join(ICGC_subtype_info %>%
            mutate(SampleID = gsub("-", "_", SampleID))) %>%
  mutate(`Subtype` = if_else(Project == "OV", group, `Subtype` )) %>%
  dplyr::select(-SampleID, -group)



TCGA_subtype <- TCGA_subtype_complete %>%
  filter(Project %in% c("OV","TGCT", "STAD","LGG","BC", "UCEC"))

```
##HRD score
```{r HRD_score}
DDR_score <-as.data.frame(fread("data/supporting/ddr_scores/DDRscores.tsv", header= F, na.strings = "NaN", fill = T))
DDR_score_colname <- unlist(fread("data/supporting/ddr_scores/Scores.tsv", header = F))
DDR_score_rowname <- fread("data/supporting/ddr_scores/Samples.tsv", header = F)
colnames(DDR_score) <- DDR_score_colname
DDR_score$Sample.ID_short<- DDR_score_rowname$V1

ov_hrd <- as.data.frame(fread("data/processed/hrd_icgc/ICGC_OV_WGS_HRD_score.tsv")) %>%
  pivot_wider(names_from = HRD_components, values_from = HRD_values) %>%
  mutate(ICGC_ID = gsub("-", "_", ICGC_ID),
         Sample_ID = gsub("-", "_", Sample_ID)) %>%
  mutate(Sample.ID = paste(ICGC_ID, Sample_ID, sep = "_"))
ov_hrd_array <- as.data.frame((fread("data/processed/hrd_icgc/ICGC_OV_HRD_array_score.tsv")))%>%
  pivot_wider(names_from = HRD_components, values_from = HRD_values) %>%
  mutate(ICGC_ID = gsub("-", "_", ICGC_ID),
         Sample_ID = gsub("-", "_", Sample_ID)) %>%
  mutate(Sample.ID = paste(ICGC_ID, Sample_ID, sep = "_"))

hrd_score <- beta_sub_meth_t %>%
  mutate(Methylation= if_else(Methylation == "No", Methylation, gene)) %>%
  distinct() %>%
  group_by(Project, Sample.ID) %>%
  mutate(methylation_coexit = sum(Methylation != "No")) %>%
  mutate(Methylation = if_else(methylation_coexit >1 , "BRCA1 & RAD51C", Methylation))%>%
  distinct() %>%
  filter((methylation_coexit != 1) |(methylation_coexit ==1 & Methylation != "No") ) %>%
  dplyr::select(-methylation_coexit, -gene) %>%
  mutate(Sample.ID_short = substr(Sample.ID,1,15)) %>%
  left_join(DDR_score %>%
              dplyr::select(HRD_Score, starts_with("HRD"), Sample.ID_short)) %>%
  left_join(ov_hrd %>%
              dplyr::select(-c("ICGC_ID", "Sample_ID")), by = "Sample.ID" ) %>%
  mutate(HRD_TAI = if_else(Project == "OV", TAI, HRD_TAI),
         HRD_LOH = if_else(Project == "OV", LOH, HRD_LOH),
         HRD_LST = if_else(Project == "OV", LST, HRD_LST),
         HRD_Score = if_else(Project == "OV", `HRD-sum`, HRD_Score)) %>%
  dplyr::select(-c("TAI", "LOH", "LST", "HRD-sum")) %>%
  left_join(ov_hrd_array %>%
              dplyr::select(-c("ICGC_ID", "Sample_ID")), by = "Sample.ID" ) %>%
  mutate(HRD_TAI = if_else(Project == "ICGC_OV" & is.na(HRD_TAI), TAI, HRD_TAI),
         HRD_LOH = if_else(Project == "ICGC_OV" & is.na(HRD_LOH), LOH, HRD_LOH),
         HRD_LST = if_else(Project == "ICGC_OV" & is.na(HRD_LST), LST, HRD_LST),
         HRD_Score = if_else(Project == "ICGC_OV"& is.na(HRD_Score), `HRD-sum`, HRD_Score))%>%
  dplyr::select(-c("TAI", "LOH", "LST", "HRD-sum")) 
  
```
##Signature
```{r}
sig_colours_cosmicv2 <- c( "#943503","#8d69a3",
                          "#7a5093", "#541e75","#420666",
                          "#360678","#fa939e",
                          "#f97886",
                          "#118866",
                          "#a0c41c","#809c16",
                          "#85c1e9","#3498db","#009999",
                          "#7c94ac", "#7c94ac",
                          "#6a85a0","#577694","#577694",
                          "#8d958f")

tcga_sig <- fread("data/processed/Signatures/tables/default_cosmicv2_sig_tcga.tsv")
icgc_sig <- fread("data/processed/Signatures/tables/default_cosmicv2_sig_icgc.tsv")


tcga_sig <- tcga_sig %>%
  mutate(Sample.ID = substr(Sample, 1, 15)) %>%
  group_by(Sample.ID) %>%
  filter(n() ==1 | (n()>1 & endsWith(Sample, "01A"))) %>%
  ungroup()  %>%
  dplyr::select(-Sample.ID)

sig <- tcga_sig %>%
  bind_rows(icgc_sig)

sig[is.na(sig)] <- 0

hrd_score_tcga <- hrd_score %>%
  filter(Project != "OV") %>%
  dplyr::select(Project, Methylation ,Sample.ID, HRD_Score) %>%
  mutate(Sample.ID = substr(Sample.ID, 1, 15)) %>%
  left_join(tcga_sig %>% 
              mutate(Sample.ID = substr(Sample, 1, 15)) %>%
              dplyr::select(-"Sample")) %>%
  distinct()

hrd_score_icgc <- hrd_score %>%
  filter(Project == "OV") %>%
  dplyr::select(Project, Methylation,Sample.ID , HRD_Score)%>%
  left_join(sig %>% dplyr::rename(Sample.ID =Sample )) %>%
  distinct()
  
  
hrd_predictors <- rbind(hrd_score_tcga, hrd_score_icgc)

```
##ICGC msi and tmb
```{r}
# icgc_tmb <- Sys.glob("/working/genomeinfo/share/analysis/AOCS_-_ICGC_ovarian_cancer_project/MAFs/*shc.maf.gz") %>%
#   map_dfr(~fread(cmd = paste0("gunzip -cq ", .x), skip = "Hugo_Symbol") %>%
#             mutate(Sample.ID =.x) %>%
#   separate(Tumor_Sample_Barcode, into = c("id_1", "id_2"), extra = "drop", sep = ":") %>%
#   mutate(Sample.ID = gsub("-", "_",paste(id_1, id_2, sep = "-")) ))%>%
#   filter((!Effect_Ontology %in% c("5_prime_UTR_variant", "3_prime_UTR_variant", "synonymous_variant", "intron_variant", "intergenic_region") & (! Variant_Classification %in% c("3'Flank", "5'Flank")))) %>%
#   group_by(id_1, id_2) %>%
#   summarise(n=n())

# icgc_tmb <- icgc_tmb %>%
#   mutate(TMB = n/30)
# 
# write.csv(icgc_tmb, "data/processed/tmb_icgc.csv",quote = F, row.names = F)

icgc_tmb <- fread("data/processed/tmb_icgc.csv")
icgc_msi <- Sys.glob("data/processed/msi_icgc/AOCS-[0-9]*") %>%
  map_dfr(~ as.data.frame(fread(.x) )%>%
            mutate(Sample.ID = basename(.x))) %>%
  dplyr::select(Sample.ID, icgc_MSI_Score = `%`)


mutation_burden <- TCGA_subtype_complete %>%
 left_join(icgc_tmb %>%
             ungroup() %>%
             mutate(Sample.ID_original = gsub("-", "_", paste(id_1, id_2, sep = "-"))) %>%
             dplyr::select(Sample.ID_original, tmb_icgc = TMB)) %>%
  left_join(icgc_msi %>%
             mutate(Sample.ID_original = gsub("-", "_",Sample.ID)) %>%
              dplyr::select(Sample.ID_original, icgc_MSI_Score)) %>%
  mutate(TMB_nonsilent = if_else(Project =="OV", as.character(tmb_icgc), as.character(TMB_nonsilent)),
         MSI_Score = if_else(Project =="OV", as.character(icgc_MSI_Score),  as.character(MSI_Score)),
         Aneuploidy_Score = as.character(Aneuploidy_Score)) %>%
  dplyr::select(-tmb_icgc, -icgc_MSI_Score) %>%
  pivot_longer(cols = c(MSI_Score, Aneuploidy_Score, TMB_nonsilent), values_to = "value", names_to = "parameter_name") %>%
  mutate(value = as.numeric(value))


  
```
## ICGC HRDetect
```{r}
ov_hrdetect <- fread("tables/hrdetect.tsv") %>%
  dplyr::rename(Sample.ID = Tumor_Sample) %>%
  mutate(Sample.ID = gsub("-", "_", Sample.ID)) %>%
  right_join(hrd_score_icgc) %>%
  filter(Sample.ID %in% unique(beta_sub_meth[which(beta_sub_meth$Sample_Group =="Primary Tumor" & beta_sub_meth$Project == "OV"), "Sample.ID"])) %>%
  mutate(Donor.ID = substr(Sample.ID, 1, 8))  %>%
  distinct()


#duplicated samples
ov_hrdetect%>%
  group_by(Donor.ID) %>%
  filter(n()>1)


ov_hrdetect %>%
  group_by(Donor.ID) %>%
  slice(1) %>%
  ungroup() %>%
  ggplot(aes(y = hrdetect_score, x = Methylation, color = Methylation))+
  geom_jitter()+
  scale_color_manual(values = methylation_color)+
  theme_bw()

#cross checking
published<- fread("data/supporting/HRDetect.csv")
ov_hrdetect %>%
  left_join(published %>%
              mutate(Sample = gsub("-", "_", Sample)), by =c("Donor.ID" = "Sample")) %>%
  dplyr::select(Donor.ID, predictorProb, hrdetect_score, Methylation, HRD_Score) %>%
  ggplot(aes(x = predictorProb, y = hrdetect_score)) +
  geom_point()+
  ylab("in house") +
  xlab("publication")

ov_hrdetect %>%
  ggplot(aes(x = HRD_Score, y = hrdetect_score))+
  geom_point()+
  geom_vline(xintercept = 42)+
  geom_hline(yintercept = 0.7)
```



#Figure 1
##Main figure 1a - prevalence
```{r Main figure 1}
#methylation, a & b
 prevalence_plot <- beta_sub_meth_t %>%
  mutate(Sample.ID = substr(Sample.ID, 1, 12)) %>%
  dplyr::select(gene, Project, Methylation, Sample.ID) %>%
  distinct() %>%
  group_by(gene, Project) %>%
  summarise(count = sum(Methylation== "Yes"), total = n()) %>%
  ungroup() %>%
  group_by(Project) %>%
  mutate(sum_methylated = sum(count)) %>%
  ungroup()%>%
  mutate(Prevalence = count/total) %>%
  dplyr::rename(Gene_Methylated = gene, TCGA_dataset = Project) %>%
  group_by(Gene_Methylated, .keep =T) %>%
  group_map(~ ggplot(data = .x, aes(x=reorder(TCGA_dataset, -(sum_methylated/total)), y= Prevalence, fill = Gene_Methylated)) +
  geom_bar(stat="identity", position="dodge") +
  scale_fill_manual(name = "Gene Methylated", values = methylation_color, limits = force)+
  scale_y_continuous(labels = scales::percent, name = "Prevalence of Methylation") +
  scale_x_discrete(name = "Cancer Types") +
  theme_bw()+
  geom_text(aes(label=paste0(percent(Prevalence), "   " ,count," ", "/"," ", total), y = 0.05), colour="black", size =3, position=position_dodge(width = .9), angle = 90)+
  theme(axis.text.x = element_text(vjust = 0.5), legend.key.size = unit(0.5, 'cm'),legend.title = element_text(size=10), legend.position = "none", legend.margin = margin(0,0,0,0), legend.box.margin=margin(-2,0,0,0),legend.justification = "top",rect = element_rect(fill = "transparent"), strip.background = element_rect(fill = "white", colour = "black"), panel.spacing = unit(0.2,'lines'),
        plot.margin = margin(0.8, 0.2, 0.2, 0.2, "cm"))+
  facet_wrap(~Gene_Methylated), .keep = T )


  
#assemble plot
  ggarrange(prevalence_plot[[1]]+theme(axis.title.x=element_blank()), 
            prevalence_plot[[2]]+theme(axis.title.x=element_blank()), align = "h",nrow = 2)
  ggsave("plots/Main_Figure_1_Prevalence_of_RAD51C_BRCA1me.pdf", device = "pdf", width = 10, height = 6 )
```
##Main figure 1b - histo subtype
```{r}
histo_stack_plot <- TCGA_subtype %>%
  filter(!(is.na(`Cancer Type Detailed`)| `Cancer Type Detailed` == "NA")) %>%
  mutate(Methylation = factor(Methylation, levels = c("BRCA1 & RAD51C", "BRCA1", "RAD51C", "No")),
         Project = factor(Project, levels = c("TGCT", "STAD","LGG","BC", "UCEC"))) %>%
  ggplot(aes(fill = Methylation)) +
              geom_bar(stat = "count", position = "stack", colour = "black", size=0.2, aes( x = `Cancer Type Detailed`))+
  scale_fill_manual(values =methylation_color, limits = force, name = "Methylated Gene")+
  theme_bw()+
  facet_wrap(~Project, scales = "free", nrow = 1)+
            geom_bar(stat = "count", position = "stack", colour = "black", size=0.2, aes( x = `Cancer Type Detailed`)) + 
            theme(plot.margin = margin(0.1,0.1,0,0.1, "lines"),
                  panel.spacing = unit(0,"null"),strip.background = element_blank(),strip.text = element_blank(),
                    axis.text.y = element_text(hjust=1.2), axis.text.x = element_text(angle = 45, hjust =1),
                  axis.title.x = element_blank())+
            scale_x_discrete(labels = wrap_format(18) )+
             scale_y_continuous("Patient Number(count)")


histo_percent_plot <- TCGA_subtype %>%
  filter(!(is.na(`Cancer Type Detailed`)| `Cancer Type Detailed` == "NA")) %>%
  mutate(Methylation = factor(Methylation, levels = c("BRCA1 & RAD51C","BRCA1", "RAD51C", "No")),
         Project = factor(Project, levels = c("TGCT", "STAD","LGG","BC", "UCEC"))) %>%
  group_by(Project, Methylation, `Cancer Type Detailed`) %>%
  summarise(cnt = n()) %>%
  ungroup() %>%
  group_by(Project) %>%
  complete(Methylation, `Cancer Type Detailed`,
           fill = list(cnt = 0)) %>%
  filter(! is.na(Project) ) %>%
  group_by(Project, `Cancer Type Detailed`) %>%
  mutate(percent = cnt/sum(cnt)) %>%
  ungroup() %>%
  filter(Methylation != "No") %>%
  ggplot(aes(fill = Methylation, y = percent, x = `Cancer Type Detailed`))+
  geom_bar(stat = "identity", position = "stack", colour = "black", size=0.2)+
  scale_fill_manual(values =methylation_color,  name = "Methylated Gene")+
  theme_bw()+
  theme(legend.position = "bottom",axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(), 
                    plot.margin = margin(0,0.1,0,0.1, "lines"), panel.spacing = unit(0,"null"),
                    axis.text.y = element_text(hjust=1.2),strip.background = element_rect(fill = "white", colour = "black")) +
              scale_y_continuous(labels = scales::percent, "Patient Number(%)")+
  facet_wrap(~Project, scales = "free", nrow = 1)

legend = get_legend(histo_percent_plot)


histo <- ggarrange(histo_percent_plot, histo_stack_plot,nrow =2, align = "v",common.legend = T, legend = "none")



subtype_stack_plot <- TCGA_subtype %>%
  filter(!(is.na(Subtype)| Subtype == "NA"), !is.na(Project), Project != "TGCT") %>%
  mutate(Methylation = factor(Methylation, levels = c("BRCA1 & RAD51C", "BRCA1", "RAD51C", "No")),
         Project = factor(Project, levels = c("TGCT","OV","STAD","LGG","BC", "UCEC"))) %>%
  ggplot(aes(fill = Methylation)) +
              geom_bar(stat = "count", position = "stack", colour = "black", size=0.2, aes( x = Subtype))+
  scale_fill_manual(values =methylation_color, limits = force, name = "Methylated Gene")+
  theme_bw()+
  facet_wrap(~Project, scales = "free", nrow = 1)+
            theme(plot.margin = margin(0,0.1,0,0.1, "lines"),
                  panel.spacing = unit(0,"null"),strip.background = element_blank(),strip.text = element_blank(),
                    axis.text.y = element_text(hjust=1.2), axis.text.x = element_text(angle = 45, hjust =1),
                  axis.title.x = element_blank())+
            scale_x_discrete(labels = wrap_format(20))+
             scale_y_continuous("Patient Number(count)")


subtype_percent_plot <- TCGA_subtype %>%
  filter(!(is.na(Subtype)| Subtype == "NA"), !is.na(Project), Project != "TGCT") %>%
  mutate(Methylation = factor(Methylation, levels = c("BRCA1 & RAD51C","BRCA1", "RAD51C", "No")),
         Project = factor(Project, levels = c("TGCT","OV", "STAD","LGG","BC", "UCEC"))) %>%
  group_by(Project, Methylation, Subtype) %>%
  summarise(cnt = n()) %>%
  ungroup() %>%
  group_by(Project) %>%
  complete(Methylation, Subtype,
           fill = list(cnt = 0)) %>%
  filter(! is.na(Project) ) %>%
  group_by(Project, Subtype) %>%
  mutate(percent = cnt/sum(cnt)) %>%
  ungroup() %>%
  filter(Methylation != "No") %>%
  ggplot(aes(fill = Methylation, y = percent, x = Subtype))+
  geom_bar(stat = "identity", position = "stack", colour = "black", size=0.2,show.legend = FALSE)+
  scale_fill_manual(values =methylation_color,  name = "Methylated Gene", limits = force)+
  theme_bw()+
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(), 
                    plot.margin = margin(0,0.1,0,0.1, "lines"), panel.spacing = unit(0,"null"),
                    axis.text.y = element_text(hjust=1.2),strip.background = element_rect(fill = "white", colour = "black")) +
              scale_y_continuous(labels = scales::percent, "Patient Number(%)")+
  facet_wrap(~Project, scales = "free", nrow = 1)


molecular <- ggarrange(subtype_percent_plot, subtype_stack_plot,nrow =2, align = "v", legend = "bottom", legend.grob = legend)

ggarrange(histo, NA, molecular, nrow = 3, align = "v", heights = c(0.44,0.02, 0.44))

ggsave("plots/Main_Figure_1_Subtype_distribution.pdf",device = "pdf", height = 10,width = 11)
     
```
##Supplementary plot 1- HR gene promoter
```{r}
pdf("plots/Supplementary/Sup1_promoter_methylation_level.pdf",width = 10, height = 12)
beta_sub %>%
  filter(Sample_Group %in% c("Primary Tumor", "Solid Tissue Normal"), !is.na(gene_promo_200), gene_promo_200 != "CHEK2") %>%
  group_by(Project, Sample_Group) %>%
  mutate(Sample_N = if_else(Sample_Group == "Primary Tumor", paste0("T=", n_distinct(Sample.ID)),paste0("N=", n_distinct(Sample.ID)))) %>%
  ungroup() %>%
  mutate(Sample_Group = factor(Sample_Group, levels= c("Primary Tumor", "Solid Tissue Normal")),
         Project = factor(Project, levels = c("OV", "TGCT", "STAD", "BC", "LGG", "SKCM", "GBM", "UCEC","COAD", "LUSC", "HNSC", "PAAD", "LIHC", "THCA", "BLCA", "CESC", "ESCA", "KIRC", "KIRP", "LUAD", "PCPG", "PRAD", "THYM")),
         gene_promo_200 = factor(gene_promo_200, levels = c("BRCA1", "RAD51C", "BRIP1", "BRCA2", "PALB2", "RAD51B", "RAD51D", "XRCC3"))) %>%
  arrange(Sample_Group) %>%
  group_by(Project) %>%
  mutate(Sample_N = paste(unique(Sample_N), collapse = "\n")) %>%
  ungroup() %>%
  mutate(Sample_N = factor(Sample_N,levels = unique(Sample_N[order(Project)]))) %>%
  group_by(gene_promo_200,  Project,Sample_Name, Sample_Group, Sample_N) %>%
  summarise(avg_meth_level = mean(beta)) %>%
  dplyr::rename(`Sample Type` = Sample_Group) %>%
  ggplot(aes(y = avg_meth_level, x= Project, color = `Sample Type`))+
  geom_boxplot(outlier.size = 0.2, size = 0.3)+
  facet_grid(rows = vars(gene_promo_200), cols = vars(Sample_N), scales = "free", space = "free", margins = F)+
  ylab("Average Methylation Level at Promoter(+-200bps)")+
  xlab("Dataset")+
  geom_hline(yintercept = 0.25, linetype = 3)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust =1), legend.position = "bottom",
        panel.spacing.x=unit(0, "lines"),
        strip.text.x = element_text(size = 6), panel.border=element_blank(),
        strip.background = element_rect(fill="white"))+
  scale_y_continuous(labels= scales::percent,limits = c(0,1))
dev.off()

```

##Supplementary plot 2 - methylation heatmap 
```{r}
beta_sub_ht <- beta_sub %>%
  filter(PredefinedCpG %in% c("BRCA1", "RAD51C"), Sample_Group == "Primary Tumor", Sample_Name %in% Deduplicated_beta$Sample_Name) %>%
  mutate(CaseID = if_else(Project =="OV", substr(start = 1,stop = 8, Sample.ID), substr(start = 1,stop = 12, Sample.ID))) %>%
  left_join(beta_sub_meth_t%>%
              mutate(CaseID = if_else(Project =="OV", substr(start = 1,stop = 8, Sample.ID), substr(start = 1,stop = 12, Sample.ID))) %>%
              filter(Methylation == "Yes") %>%
  dplyr::select(gene, CaseID) %>% mutate(gene = factor(gene, levels = c("BRCA1", "RAD51C"))) %>%
  group_by(CaseID) %>%
  arrange(gene) %>%
  summarise(Methylation = paste(gene, collapse = " & ")) %>%
  ungroup(), by = c("CaseID")) %>%
  filter(!is.na(Methylation)) %>%
  mutate(Methylation = factor(Methylation, levels= c("BRCA1", "RAD51C", "BRCA1 & RAD51C")))  %>%
  
  arrange(Methylation)

ht_row_meth <-beta_sub_ht%>%
               dplyr::select(CaseID, Methylation) %>%
               distinct() %>%
  column_to_rownames("CaseID") %>%
  arrange(Methylation)

ht_start_cg <- beta_sub_ht %>%
  dplyr::select(CpG,gene,chr_start) %>%
  distinct() %>%
  column_to_rownames("chr_start")



htmap_list <- beta_sub_ht %>%
  dplyr::select(CaseID, chr_start, beta, Project) %>%
  distinct()%>%
  filter(Project %in% c("OV", "TGCT", "STAD", "BC", "LGG","UCEC", "LUSC", "THCA")) %>%
   split(list(.$Project)) %>%
  map( ~ pivot_wider(.x, names_from = chr_start, values_from = beta) %>%
         select_if(~ !any(is.na(.))) %>%
         dplyr::select( -Project) %>%
         column_to_rownames(var = "CaseID") %>%
         `colnames<-`(unlist(ht_start_cg[colnames(.), "CpG"])) %>%
         as.matrix() %>%
         Heatmap(. , col =colorRamp2(seq(0, 1, length =3), c("blue", "white", "red")),
                 show_row_names = F,  cluster_columns = F, cluster_rows = F,
                 # show_heatmap_legend = F, 
                 show_heatmap_legend = T,
                 column_title = unique(.x$gene_promo_200), 
                 column_names_gp = gpar(fontsize = 10),
                 column_title_gp = gpar(fontsize = 7), 
                 column_split = ht_start_cg[which(ht_start_cg$CpG ==colnames(.)), "gene"], 
                 row_order = rownames(ht_row_meth[rownames(.),"Methylation"]),
                 right_annotation = rowAnnotation(Methylated = ht_row_meth[rownames(.),"Methylation"], 
                                                  col = list(Methylated = methylation_color_ht)
                                                  , show_legend = F
                                                  ),
                  top_annotation = HeatmapAnnotation(Gene = anno_block( labels = c("BRCA1", "RAD51C"),
                                                                      labels_gp = gpar(col = "black", fontsize = 10)))))


pdf("plots/Supplementary/Sup2_heatmap_methylation.pdf")
pdf("plots/Supplementary/Sup2_heatmap_methylation_NO_LEGEND.pdf")
# grid.newpage()
# pushViewport(viewport(layout = grid.layout(nr = 10, nc = 4, heights = unit(rep(c(18),5), "null"), widths = unit(c(0.5,5,0.5,5),"null" ))))
# for (x in 1:length(htmap_list)){
#   grid.text(names(htmap_list)[x], vp = viewport(layout.pos.row = if_else(x%%2==0, x-1, x), layout.pos.col = if_else(x%%2==0, 3, 1)))
#   pushViewport(viewport(layout.pos.row = if_else(x%%2==0, x-1, x), layout.pos.col = if_else(x%%2==0, 4, 2)))
#   draw(htmap_list[[x]], newpage = FALSE)
#   upViewport()
# }
for (x in 1:length(htmap_list)){
  grid.newpage()
   # pushViewport(viewport(layout = grid.layout(nr = 1, nc = 1)))
    pushViewport(viewport(layout = grid.layout(nr = 2, nc = 1, heights = unit(c(0.5, 5), "null"))))
    grid.text(names(htmap_list)[x], vp = viewport(layout.pos.row = 1, layout.pos.col = 1))
    pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 1))
  draw(htmap_list[[x]], newpage = FALSE)
  upViewport()
}
dev.off()


```
##Supplementary Table 1 - methylation
```{r}
write.csv(beta_sub_meth %>%
  mutate(Sample_Group = gsub("Tumor", "Tumour", Sample_Group)) %>%
  filter(Sample_Group == "Primary Tumour",Sample_Name %in% Deduplicated_beta$Sample_Name) %>%
  mutate(CaseID = if_else(Project == "OV", substr(Sample.ID, 1,8), substr(Sample.ID, 1, 15)),
         BRCA2me = if_else(CaseID == "TCGA-E2-A1LA-01", "Yes", "No"),
         BRIP1me = if_else(CaseID %in% c("TCGA-C5-A2LT-01","TCGA-CC-A3MA-01","TCGA-SL-A6JA-01","TCGA-AJ-A8CW-01"), "Yes", "No"),
         PABL2me = if_else(CaseID  == "TCGA-77-7142-01", "Yes", "No")) %>%
  dplyr::select(CaseID, Dataset = Project, BRCA1me = BRCA1_M, RAD51Cme = RAD51C_M, BRCA2me, BRIP1me, PABL2me ) %>%
  distinct(), "data/supplementary_data/Table_S1_methylation.csv", quote = F, row.names = F)

```
##Supplementary plot 3 BRCA2, PALB2 and BRIP1
```{r}
PALB2_meth <- beta_sub %>%
  filter( Project %in% c("LUSC"), Sample_Group %in% c("Primary Tumor", "Solid Tissue Normal"), gene_promo_200 == "PALB2") %>%
    mutate(CpG = factor(CpG, levels = unique(beta_sub$CpG[order(beta_sub$chr_start)])), gene2=gene) %>%
  group_by(Sample_Name, Sample_Group) %>%
  mutate(color = if_else(sum(CpG == "cg05534473" & beta > 0.25 & Sample_Group == "Primary Tumor")>0, "Methylated", "Unmethylated"),
         ) %>%
  ungroup() %>%
  ggplot(aes(x = CpG, y = beta, group = Sample_Name, colour = color)) +
                geom_point(data = .%>% filter(color == "Unmethylated"), alpha = 0.5) +
                geom_line(data = .%>% filter(color == "Unmethylated"), alpha = 0.2) +
  geom_point(data = .%>% filter(color == "Methylated")) +
                geom_line(data = .%>% filter(color == "Methylated")) +
                facet_grid(rows = vars(Sample_Group), cols = vars(Project), switch = "y", space = "free") +
                theme_bw()+
                theme(axis.text.x = element_text(angle = -45, vjust = 0.5), legend.position = "bottom",strip.background = element_rect(fill="white")) +
  scale_color_manual(values = c("Methylated" = "#D90368", "Unmethylated" = "grey"), "PALB2")+
                scale_y_continuous(breaks=c(0,0.25,0.5,0.75,1.0), expand=c(0,0), position = "right", limits = c(-0.1,1))+
                geom_tile(aes(x= CpG, y = -0.05, fill = CpG_context, height = 0.05), color = NA) +
                scale_fill_brewer("CpG context", palette = "Reds",  guide = guide_legend(order = 2),  direction=-1)+
  xlab("Probes")



BRCA2_meth <- beta_sub %>%
  filter( Project %in% c("BC"), Sample_Group %in% c("Primary Tumor", "Solid Tissue Normal"), gene_promo_200 == "BRCA2")%>%
    mutate(CpG = factor(CpG, levels = unique(beta_sub$CpG[order(beta_sub$chr_start)])), gene2=gene) %>%
  group_by(Sample_Name, Sample_Group) %>%
  mutate(color = if_else(sum(CpG == "cg20073910" & beta > 0.25 & Sample_Group == "Primary Tumor")>0, "Methylated", "Unmethylated")) %>%
  ungroup() %>%
  ggplot(aes(x = CpG, y = beta, group = Sample_Name, colour = color)) +
                geom_point(data = .%>% filter(color == "Unmethylated"), alpha = 0.5) +
                geom_line(data = .%>% filter(color == "Unmethylated"), alpha = 0.2) +
  geom_point(data = .%>% filter(color == "Methylated")) +
                geom_line(data = .%>% filter(color == "Methylated")) +
                facet_grid(rows = vars(Sample_Group), cols = vars(Project), switch = "y", space = "free") +
                theme_bw()+
                theme(axis.text.x = element_text(angle = -45, vjust = 0.5), legend.position = "bottom",strip.background = element_rect(fill="white")) +
  scale_color_manual(values = c("Methylated" = "#FAA613", "Unmethylated" = "grey"), "BRCA2")+
                scale_y_continuous(breaks=c(0,0.25,0.5,0.75,1.0), expand=c(0,0), position = "right", limits = c(-0.1,1))+
                geom_tile(aes(x= CpG, y = -0.05, fill = CpG_context, height = 0.05), color = NA) +
                scale_fill_brewer("CpG context", palette = "Reds",  guide = guide_legend(order = 2),  direction=-1)+
  xlab("Probes")

BRIP1_meth <- beta_sub %>%
  filter( Project %in% c("CESC", "LIHC", "UCEC"), Sample_Group %in% c("Primary Tumor", "Solid Tissue Normal"), gene_promo_200 == "BRIP1") %>%
    mutate(CpG = factor(CpG, levels = unique(beta_sub$CpG[order(beta_sub$chr_start)])), gene2=gene) %>%
  group_by(Sample_Name, Sample_Group) %>%
  mutate(color = if_else(sum(CpG == "cg00515161" & beta > 0.25 & Sample_Group == "Primary Tumor")>0, "Methylated", "Unmethylated")) %>%
  ungroup() %>%
  ggplot(aes(x = CpG, y = beta, group = Sample_Name, colour = color)) +
                geom_point(data = .%>% filter(color == "Unmethylated"), alpha = 0.5) +
                geom_line(data = .%>% filter(color == "Unmethylated"), alpha = 0.2) +
  geom_point(data = .%>% filter(color == "Methylated")) +
                geom_line(data = .%>% filter(color == "Methylated")) +
                facet_grid(rows = vars(Sample_Group), cols = vars(Project), switch = "y", space = "free") +
                theme_bw()+
                theme(axis.text.x = element_text(angle = -45, vjust = 0.5), legend.position = "bottom",strip.background = element_rect(fill="white")) +
  scale_color_manual(values = c("Methylated" = "#4F4789", "Unmethylated" = "grey"), "BRIP1")+
                scale_y_continuous(breaks=c(0,0.25,0.5,0.75,1.0), expand=c(0,0), position = "right", limits = c(-0.1,1))+
                geom_tile(aes(x= CpG, y = -0.05, fill = CpG_context, height = 0.05), color = NA) +
                scale_fill_brewer("CpG context", palette = "Reds",  guide = guide_legend(order = 2),  direction=-1)+
  xlab("Probes")

ggsave(plot = PALB2_meth,filename = "plots/Supplementary/Sup3_PALB2me.pdf", height = 297/3*1.1, width = 200*1.1, units = "mm")
ggsave(plot = BRCA2_meth,filename = "plots/Supplementary/Sup3_BRCA2me.pdf", height = 297/3*1.1, width = 200*1.1, units = "mm")
ggsave(plot = BRIP1_meth,filename = "plots/Supplementary/Sup3_BRIP1me.pdf", height = 297/3*1.1, width = 200*1.1, units = "mm")


```

##Supplementary Table 2 -subtype fisher
```{r}
Molecular_subtype_table <- TCGA_subtype %>%
  dplyr::select(Project, Subtype, Methylation) %>%
  separate_rows(Methylation, sep = " & ") %>%
  filter(!is.na(Subtype)) %>%
  group_by(Project, Subtype, Methylation) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  group_by(Project) %>%
  complete(Subtype, Methylation, fill = list(n=0)) %>%
  ungroup() %>%
  group_by(Project, Subtype) %>%
  mutate(subtype_total = sum(n)) %>%
  ungroup() %>%
  group_by(Project, Methylation) %>%
  mutate(Methylation_total = sum(n)) %>%
  ungroup() %>%
  filter(Methylation_total > 1) %>%
  group_by(Project) %>%
  mutate(Cancer_total = sum(n)) %>%
  ungroup() %>%
  filter(Methylation != "No") %>%
  mutate(Meth_subtype = n, Meth_NOT_subtype = Methylation_total - n,
         Unmeth_subtype = subtype_total - n, Unmeth_Not_subtype = Cancer_total - subtype_total - (Methylation_total - n)) %>%
  dplyr::select(-n, -subtype_total, - Methylation_total, - Cancer_total)

Molecular_subtype_fisher <- Molecular_subtype_table %>%
  group_by(Project, Subtype, Methylation) %>%
  group_map(~ fisher.test(x = t(matrix(unlist(.x),byrow = T, nrow = 2))))

Molecular_subtype_table$fisher <- unlist(lapply(Molecular_subtype_fisher, function(x) x$p.value))
Molecular_subtype_table$odds_ratio <- unlist(lapply(Molecular_subtype_fisher, function(x) x$estimate))
Molecular_subtype_table$fisher <- unlist(lapply(Molecular_subtype_fisher, function(x) x$p.value))
Molecular_subtype_table%<>%
  group_by(Project) %>%
  mutate(fisher.adj = p.adjust(fisher))%>%
  ungroup()

write.csv(Molecular_subtype_table %>%
            filter(Project != "TGCT"), "data/supplementary_data/Table_S2_Subtype_fishers_molecular.csv", quote = F, row.names = F)

#Histological
Histo_subtype_table <- TCGA_subtype %>%
  separate_rows(Methylation, sep = " & ") %>%
  dplyr::select(Project, `Cancer Type Detailed`, Methylation) %>%
  filter(!is.na(`Cancer Type Detailed`)) %>%
  group_by(Project, `Cancer Type Detailed`, Methylation) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  group_by(Project) %>%
  complete(`Cancer Type Detailed`, Methylation, fill = list(n=0)) %>%
  ungroup() %>%
  group_by(Project, `Cancer Type Detailed`) %>%
  mutate(subtype_total = sum(n)) %>%
  ungroup() %>%
  group_by(Project, Methylation) %>%
  mutate(Methylation_total = sum(n)) %>%
  ungroup() %>%
  filter(Methylation_total > 1) %>%
  group_by(Project) %>%
  mutate(Cancer_total = sum(n)) %>%
  ungroup() %>%
  filter(Methylation != "No") %>%
  mutate(Meth_subtype = n, Meth_NOT_subtype = Methylation_total - n,
         Unmeth_subtype = subtype_total - n, Unmeth_Not_subtype = Cancer_total - subtype_total - (Methylation_total - n)) %>%
  dplyr::select(-n, -subtype_total, - Methylation_total, - Cancer_total)

Histo_subtype_fisher <- Histo_subtype_table %>%
  group_by(Project, `Cancer Type Detailed`, Methylation) %>%
  group_map(~ fisher.test(x = t(matrix(unlist(.x),byrow = T, nrow = 2))))

Histo_subtype_table$fisher <- unlist(lapply(Histo_subtype_fisher, function(x) x$p.value))
Histo_subtype_table$odds_ratio <- unlist(lapply(Histo_subtype_fisher, function(x) x$estimate))
Histo_subtype_table%<>%
  group_by(Project) %>%
  mutate(fisher.adj = p.adjust(fisher))%>%
  ungroup()

write.csv(Histo_subtype_table, "data/supplementary_data/Table_S2_Subtype_fishers_histo.csv", quote = F, row.names = F)
```

#Main figure 2 - demographic methylation
```{r}
#subset demographic summary for methylated sample
demograph_table_meth %>%
  dplyr::rename(consensus_ancestry =SNP_ancestry)
methylation_color-> methylation_color2
methylation_color2["No"] = alpha("grey" , 0.9)

stage <- demograph_table_meth %>%
  mutate(Dataset = factor(Dataset, levels = c("OV","TGCT", "STAD", "LGG", "BC", "SKCM", "UCEC", "GBM","LIHC","COAD", "HNSC","LUSC","THCA","PAAD","ESCA","CESC","KIRC", "BLCA","LUAD")),
         stage = gsub("Stage ", "", stage),
          Methylation = factor(Methylation, levels= c("BRCA1", "RAD51C", "BRCA1 & RAD51C", "No"))) %>%
  group_by(Dataset,  stage) %>%
  mutate(total =n()) %>%
  ungroup() %>%
  group_by(Dataset, Methylation, stage, total) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  group_by(Methylation, Dataset) %>%
  filter(sum(n)>2) %>%
  ungroup() %>%
   group_by(Dataset) %>%
  filter(n_distinct(Methylation) >1  & n_distinct(stage )>1) %>%
  ungroup() %>%
  mutate(percent = n/total) %>%
  ggplot(aes(fill = Methylation, x = stage, y =n ))+
  geom_bar(stat="identity", position = "stack", color  = "black", size = 0.2)+
  theme_bw()+
  xlab("Stage at Diagnosis")+
  ylab("Number of Patients")+
  scale_fill_manual(values = methylation_color2, "Methylated Gene")+
  theme(legend.position = "bottom",axis.text.x = element_text(angle = 45, hjust =1), strip.background = element_rect(fill="white"))
# +scale_y_continuous(  label = scales::percent)

stage+
  facet_wrap(~Dataset, scale = "free", ncol = 3)
ggsave(file="plots/Main_Figure_2_stage_type.pdf", width = 300, height = 115, units = "mm")


#age
age_DF <- demograph_table_meth %>%
  separate_rows(Methylation, sep = " & ") %>%
   group_by(Dataset) %>%
  filter(sum(Methylation != "No") >2) %>%
  ungroup() %>%
   group_by(Dataset) %>%
  filter(n_distinct(Methylation) >1) %>%
  ungroup() %>%
  mutate(Dataset = factor(Dataset, levels = c("OV","TGCT", "STAD", "LGG", "BC", "SKCM", "UCEC", "GBM","LIHC","COAD", "HNSC","LUSC","THCA","PAAD","ESCA","CESC","KIRC", "BLCA","LUAD")),
         stage = gsub("Stage ", "", stage),
         Methylation = factor(Methylation, levels= c("BRCA1", "RAD51C", "BRCA1 & RAD51C", "No")))%>% 
  group_by(Dataset, Methylation) %>%
  mutate(Methylation_count = paste0(" (N=", n_distinct(SampleID), ")")) %>%
  ungroup() 


age_stat <- compare_means(age ~ Methylation, group.by = "Dataset",
                          data = age_DF %>%group_by(Dataset, Methylation) %>%
  filter(n_distinct(SampleID)>2) %>%
  ungroup(),
                          ref.group = "No")

age_DF %>%
  filter(Dataset != "LUSC") %>%
  ggplot(aes(y = age, x = Methylation))+
 geom_boxplot(data = . %>%
                group_by(Dataset, Methylation) %>%
  filter(n_distinct(SampleID)>2) %>%
  ungroup(),aes(fill = Methylation))+
  geom_point(data = . %>%
                group_by(Dataset, Methylation) %>%
  filter(n_distinct(SampleID)<3) %>%
  ungroup())+
  theme_bw()+
  ylab("Age at Diagnosis")+
  scale_fill_manual(values = methylation_color2, "Methylated Gene")+
  scale_color_manual(values = methylation_color2, "Methylated Gene")+
  theme(legend.position = "bottom", axis.title.x = element_blank(),strip.background = element_rect(fill="white"))+
  ylim(0, 119)+
  facet_wrap(~Dataset, scale = "free", ncol = 4)+
  stat_pvalue_manual(age_stat%>%
 mutate(y.position = c(rep(c(95, 110),2), 95, 95, 95, 110, rep(95, 3)),
        p.adj = if_else(p.adj > 0.05, "ns", paste0("q = ",as.character(p.adj)))), label = "p.adj")+
  geom_text(data =. %>%
              dplyr::select(Dataset, Methylation, Methylation_count) %>%
              distinct(), mapping = aes(y = 0, label = Methylation_count))+
  scale_x_discrete(limits = function(x) if(length(x) ==3 ){return(c("BRCA1", "RAD51C", "No"))} else{ return(c("RAD51C", "No"))})
  
ggsave(file="plots/Main_Figure_2_age_type.pdf",width = 300, height = 115, units = "mm")

#sex
 demograph_table_meth %>%
   separate_rows(Methylation, sep = " & ") %>%
   group_by(Dataset, Methylation) %>%
  filter(n_distinct(SampleID) >2) %>%
  ungroup() %>%
      mutate(level = case_when(Methylation == "BRCA1" ~ 1,
                            Methylation == "RAD51C" ~ 2,
                            Methylation == "No" ~ 4)) %>%
  filter(!Dataset  %in% c("OV", "TGCT", "UCEC", "CESC")) %>%
   group_by(Dataset) %>%
  filter(n_distinct(Methylation)>1) %>%
  ungroup() %>%
  group_by(Dataset, Methylation) %>%
  mutate(Methylation = paste0(Methylation, " (N=",n(),")", sep = ""),
         Dataset = factor(Dataset, levels = c("OV","TGCT", "STAD", "LGG", "BC", "SKCM", "UCEC", "GBM","LIHC","COAD", "HNSC","LUSC","THCA","PAAD","ESCA","CESC","KIRC", "BLCA","LUAD"))) %>%
   ungroup() %>%
   mutate(Methylation = factor(Methylation, levels = unique(Methylation[order(level)]))) %>%
  ggplot(aes(x = Methylation, fill = sex))+
  geom_histogram(stat = "count",position = "fill", color = "black", size = 0.2)+
  theme_bw()+
  xlab("Methylated Gene")+
  ylab("Percent of Patients")+
  scale_fill_manual(values = c("F" = "#D55E00","M" = "#0072B2", "NA" = "#BEBEBE"), "Sex")+
  theme(legend.position = "bottom",strip.background = element_rect(fill="white"))+
   scale_y_continuous(label = scales::percent)+
  facet_wrap(~Dataset, scale = "free_x", ncol = 9)+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 5))
ggsave(file="plots/Main_Figure_2_sextype.pdf", width = 250,height = 80, units = "mm")



#ances
 demograph_table_meth %>%
   separate_rows(Methylation, sep = " & ") %>%
   group_by(Dataset, Methylation, consensus_ancestry) %>%
  summarise(n=n()) %>%
  ungroup() %>%
   mutate(level = case_when(Methylation == "BRCA1" ~ 1,
                            Methylation == "RAD51C" ~ 2,
                            Methylation == "No" ~ 3)) %>%
   group_by(Methylation,Dataset) %>%
  filter(sum(n)>2) %>%
   mutate(Methylation = paste0(Methylation, " (N=",sum(n),")", sep = "")) %>%
  ungroup() %>%
  group_by(Dataset) %>%
  filter(n_distinct(Methylation) >1, n_distinct(consensus_ancestry) >1) %>%
   ungroup() %>%
  group_by(Dataset) %>%
  filter(n_distinct(Methylation)>1, Dataset != "OV") %>%
  ungroup() %>%
  mutate(Dataset = factor(Dataset, levels = c("OV","TGCT", "STAD", "LGG", "BC", "SKCM", "UCEC", "GBM","LIHC","COAD", "HNSC","LUSC","THCA","PAAD","ESCA","CESC","KIRC", "BLCA","LUAD")),
         Methylation = factor(Methylation, levels = unique(Methylation[order(level)])),
         consensus_ancestry = factor(consensus_ancestry , levels = c("afr", "afr_admix", "amr", "eas", "eas_admix","sas" , "sas_admix", "admix","eur", "eur_admix","NA"))) %>%
  ggplot(aes(x = Methylation, fill = consensus_ancestry, y = n))+
  geom_bar(stat = "identity", position = "fill")+
  theme_bw()+
  xlab("Methylated Gene")+
  ylab("Percent of Patients")+
  theme(legend.position = "bottom",strip.background = element_rect(fill="white"))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 5))+
  scale_y_continuous( labels = scales::percent)+
  scale_fill_manual(values = c("afr" = "#DE6B48", "afr_admix" = "#E5B181", "amr" = "#9CE4A2", "eas" = "#E9E480","eur" = "#7EBBC4", "eur_admix" = "#B2D1D5","sas" = "#9055A2", "sas_admix" ="#D499B9", "admix" = "black","NA" = "#BEBEBE"), "Consensus Ancestry")+
  facet_wrap(~Dataset, scale = "free_x", ncol = 9)+
   guides(fill = guide_legend(nrow = 2))
ggsave(file="plots/Main_Figure_2_ances.pdf", width = 300,height = 100, units = "mm")

```
##Supplementary Table 3 - demog fisher
```{r}
#age
write.csv(age_stat, "data/supplementary_data/Table_S3_Demographic_fishers_age.csv", quote = F, row.names = F)


```
##Supplementary Table 4 - sex fisher
```{r}
#sex
sex_table <-  demograph_table_meth  %>%
  filter(!is.na(sex)) %>%
  dplyr::select(Dataset, DonorID, Methylation, sex) %>%
  distinct() %>%
  group_by(Dataset, Methylation, sex) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  group_by(Methylation,Dataset) %>%
  filter(sum(n)>2) %>%
  ungroup() %>%
  group_by(Dataset) %>%
  filter(n_distinct(Methylation)> 1, n_distinct(sex)>1)%>%
  ungroup() %>%
  group_by(Dataset) %>%
  complete(sex, Methylation, fill = list(n=0)) %>%
  ungroup() %>%
  group_by(Dataset, sex) %>%
  mutate(sex_total = sum(n)) %>%
  ungroup() %>%
  group_by(Dataset, Methylation) %>%
  mutate(Methylation_total = sum(n)) %>%
  ungroup() %>%
  group_by(Dataset) %>%
  mutate(Cancer_total = sum(n)) %>%
  ungroup() %>%
  filter(Methylation != "No", sex != "M") %>%
  mutate(Meth_F = n, Meth_M = Methylation_total - n,
         Unmeth_F = sex_total - n, Unmeth_M = Cancer_total - sex_total - (Methylation_total - n)) %>%
  dplyr::select(-n, -sex_total, - Methylation_total, - Cancer_total, -sex) %>%
  distinct()

sex_fisher <- sex_table %>%
  group_by(Dataset, Methylation) %>%
  group_map(~ fisher.test(x = t(matrix(unlist(.x),byrow = T, nrow = 2))))

sex_table$fisher <- unlist(lapply(sex_fisher, function(x) x$p.value))

sex_table$odds_ratio <- unlist(lapply(sex_fisher, function(x) x$estimate))

sex_table <-  sex_table%>%
  group_by(Dataset) %>%
  mutate(fisher.adj = p.adjust(fisher))
write.csv(sex_table, "data/supplementary_data/Table_S4_sex_fishers_molecular.csv", quote = F, row.names = F)

```

#Main figure 3 cimp
```{r}
cimp_stad_lgg <- TCGA_subtype %>%
  group_by(Project, Methylation) %>%
  filter(n()>2) %>%
  ungroup() %>%
  filter(Project %in% c("STAD", "LGG")) %>%
  separate_rows(Methylation, sep = " & ") %>%
  mutate(Project = factor(Project, levels = c("OV","TGCT", "STAD", "LGG", "BC", "UCEC")),
         cimp_label = factor(cimp_label, levels = c("CIMP+", "CIMP-"))) %>%
  group_by(Project, Methylation) %>%
  mutate(Methylation_count = paste0(Methylation, " (N=", n(), ")")) %>%
  ungroup() %>%
  mutate(Methylation = factor(Methylation, levels= c("BRCA1", "RAD51C", "No")),
         Methylation_count = factor(Methylation_count, levels = unique(Methylation_count[order(Methylation)]))) %>%
  
  ggplot(aes(fill = cimp_label,  x= Methylation_count)) +
  geom_bar(stat = "count", position = "fill", color = "black") +
  facet_wrap(~Project, scale = "free")+
  theme_bw()+
  scale_fill_manual(values = col$`CIMP`, "CIMP Subtype")+
  theme(legend.position = "bottom", axis.title.x = element_blank())+ 
  scale_y_continuous(label = scales::percent)+
  ylab("Percent of Patient")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 5))

cimp_others <- TCGA_subtype %>%
   group_by(Project, Methylation) %>%
  filter(n()>2) %>%
  ungroup() %>%
   filter(!Project %in% c("STAD", "LGG")) %>%
  separate_rows(Methylation, sep = " & ") %>%
  mutate(cimp_label = case_when(is.na(cimp_label) ~"NA",
                                cimp_label == "CIMP-" ~ "Low",
                                cimp_label == "CIMPi" ~ "Intermediate",
                                cimp_label == "CIMP+" ~ "High"),
          Project = factor(Project, levels = c("OV","TGCT", "STAD", "LGG", "BC", "UCEC"))) %>%
  group_by(Project, Methylation) %>%
  mutate(Methylation_count = paste0(Methylation, " (N=", n(), ")")) %>%
  ungroup() %>%
  mutate(Methylation = factor(Methylation, levels= c("BRCA1", "RAD51C", "No")),
         Methylation_count = factor(Methylation_count, levels = unique(Methylation_count[order(Methylation)]))) %>%
  
  ggplot(aes(fill = cimp_label,  x= Methylation_count)) +
  geom_bar(stat = "count", position = "fill", color = "black") +
  facet_wrap(~Project, scale = "free", nrow =1)+
  theme_bw()+
  scale_fill_manual(values = col$`Global Methylation`, "CpG Methylation Cluster")+
  theme(legend.position = "bottom", axis.title.x = element_blank())+ 
  scale_y_continuous(label = scales::percent)+
  ylab("Percent of Patient")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 5))


ggarrange(cimp_stad_lgg, cimp_others, nrow =1, widths = c(0.35, 0.65))

ggsave(file= "plots/Main_Figure_3_cimp_frequency.pdf", height = 3.5*1.3,width = 7*2)
```

##Supplementary Table 5 cimp fisher
```{r}
cimp_table <-  TCGA_subtype  %>%
  filter(!is.na(cimp_label)) %>%
  separate_rows(Methylation, sep = " & ") %>%
  distinct() %>%
  group_by(Project, cimp_label,Methylation) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  group_by(Project) %>%
  complete(cimp_label,Methylation, fill = list(n=0)) %>%
  ungroup() %>%
  group_by(Project, cimp_label) %>%
  mutate(cimp_total = sum(n)) %>%
  ungroup() %>%
  group_by(Project, Methylation) %>%
  mutate(Methylation_total = sum(n)) %>%
  ungroup() %>%
  group_by(Project) %>%
  mutate(Cancer_total = sum(n)) %>%
  ungroup() %>%
  filter(Methylation != "No") %>%
  mutate(Meth_cimp = n, Meth_NOT_cimp = Methylation_total - n,
         Unmeth_cimp = cimp_total - n, Unmeth_Not_cimp = Cancer_total - cimp_total - (Methylation_total - n)) %>%
  dplyr::select(-n, -cimp_total, - Methylation_total, - Cancer_total) %>%
  distinct()

cimp_fisher <- cimp_table %>%
  group_by(Project, Methylation, cimp_label) %>%
  group_map(~ fisher.test(x = t(matrix(unlist(.x),byrow = T, nrow = 2))))

cimp_table$fisher <- unlist(lapply(cimp_fisher, function(x) x$p.value))

cimp_table$odds_ratio <- unlist(lapply(cimp_fisher, function(x) x$estimate))

cimp_table %<>%
  group_by(Project) %>%
  mutate(fisher.adj = p.adjust(fisher))

write.csv(cimp_table, "data/supplementary_data/Table_S5_cimp_fishers.csv", quote = F, row.names = F)
```

#Main figure 4 CIMP onco
```{r}
TCGA_subtype %>%
  filter(Project == "BC", !is.na(cimp_label),  Subtype =="Basal") %>%
  mutate(TP53= if_else(is.na(TP53), "WT", "MUT"), 
         Methylation = if_else(Methylation  =="RAD51C", "No", Methylation)) %>%
  group_by(Methylation, TP53) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  fisher.test(x= t(matrix(.$n,byrow = T, nrow = 2)))

oncoprint_matrix<- TCGA_subtype %>%
  filter(! Methylation == "No", Sample.ID %in% unique(substr(mc3_icgc$Sample.ID, 1,27))) %>%
  group_by(Project, Methylation) %>%
  filter(Project %in% c("TGCT" ,"OV", "STAD","LGG","BC", "UCEC")) %>%
  mutate(Project = factor(Project, levels = c("OV", "TGCT", "STAD","LGG","BC", "UCEC")),
         Methylation = factor(Methylation, levels = c("BRCA1", "RAD51C", "BRCA1 & RAD51C")),
         project_number = as.integer(Project),
         Subtype = if_else(Project == "TGCT",`Cancer Type Detailed`, Subtype ))%>%
  dplyr::select(-`Cancer Type Detailed`,-`Mutation Count`, -`Fraction Genome Altered`, -MSI_Score, -Aneuploidy_Score, -TMB_nonsilent) %>%
 replace(is.na(.), "") %>%
  distinct() %>%
  ungroup() %>%
  arrange(Project,Methylation, desc(TP53), cimp_label) %>%
  mutate(STAD_subtype = if_else(Project =="STAD" & Subtype != "", Subtype, "NA"),
         TGCT_subtype = if_else(Project =="TGCT" & Subtype != "", Subtype, "NA"),
         LGG_subtype = if_else(Project =="LGG"& Subtype != "", Subtype, "NA"),
         BC_subtype = if_else(Project =="BC"& Subtype != "", Subtype, "NA"),
         UCEC_subtype = if_else(Project =="UCEC"& Subtype != "", Subtype, "NA"),
         cimp_label = case_when(cimp_label == "CIMP+" ~ "High",
                                cimp_label == "CIMP-" ~ "Low",
                                cimp_label == "CIMPi" ~ "Intermediate",
                                cimp_label == "" ~"NA")) %>%
  mutate(number = row_number()) %>%
  t()
colnames(oncoprint_matrix) <- oncoprint_matrix["Sample.ID",]


#assemble oncoprint

onco <- oncoPrint(
  oncoprint_matrix[c("TP53", "PIK3CA", "IDH1", "ARID1A"),],
  alter_fun = alter_fun,
  show_pct = FALSE,
  row_names_side = "left",
  top_annotation =HeatmapAnnotation(
    Project = anno_block(labels= c("OV","TGCT", "STAD","LGG","BC", "UCEC"),labels_gp = gpar(fontsize = 10)),
    Methylation = factor(oncoprint_matrix["Methylation",], levels = c( "BRCA1", "RAD51C", "BRCA1 & RAD51C")),
    `CpG Methylation` =factor(oncoprint_matrix["cimp_label",], levels = c("High", "Intermediate", "Low", "NA")),
    `TGCT Subtype`= factor(oncoprint_matrix["TGCT_subtype",], levels = c("Mixed Germ Cell Tumor", "Yolk Sac Tumor", "NA")),
    `STAD Subtype` = factor(oncoprint_matrix["STAD_subtype",], levels = c("EBV", "CIN", "GS", "MSI", "POLE", "NA")),
    `LGG Subtype` = factor(oncoprint_matrix["LGG_subtype",], levels = c("IDHmut codel", "IDHmut non-codel", "IDHwt", "NA")),
    `BC Subtype` = factor(oncoprint_matrix["BC_subtype",], levels = c("Basal", "Her2", "LumA", "LumB", "Normal", "NA")),
    `UCEC Subtype` = factor(oncoprint_matrix["UCEC_subtype",], levels = c("CN HIGH","MSI", "NA")),
    col = col,annotation_name_gp = gpar(fontsize= 10), annotation_name_side = "left", gp = gpar(col = "white"),
    annotation_height = unit(c(1, rep(2,7)), "lines")
     # ,Meth_lvl =oncoprint_matrix["Methylation_lvl",]
   ),
  column_title = NULL, column_order = as.numeric(oncoprint_matrix["number",]),
  column_split = oncoprint_matrix["project_number",],
  heatmap_legend_param = list(direction = "horizontal",title = "Somatic Variants"))

pdf("plots/Main_Figure_4_oncoprint_methylated.pdf", height = 7,width = 15)
  # pdf("oncoprint_methylated_level.pdf", height = 8.3,width = 15)

draw(onco, annotation_legend_side = "bottom", heatmap_legend_side = "bottom", merge_legend = TRUE)
dev.off()


```

##Main figure 4 - frequent co-mutation
```{r}
  mut_beta_sub_meth_t  <- beta_sub_meth_t %>%
  mutate(CaseID = if_else(Project == "OV", substr(Sample.ID, 1, 8), substr(Sample.ID, 1, 12))) %>%
  filter( Sample.ID %in% unique(mutation_icgc$Sample.ID) | CaseID %in% unique(substr(mc3$Tumor_Sample_Barcode, 1,12))) %>%
  group_by(Project, gene) %>%
  filter(sum(Methylation != "No") > 0) %>%
  ungroup() %>%
  mutate(Methylation= if_else(Methylation == "No", Methylation, gene)) %>%
  dplyr::select(-gene) %>%
  distinct() %>%
  group_by(Project, Sample.ID) %>%
  mutate(methylation_coexit = sum(Methylation != "No")) %>%
  mutate(Methylation = if_else(methylation_coexit >1 , "BRCA1 & RAD51C", Methylation)) %>%
  separate_rows(Methylation, sep = " & ") %>%
  distinct() %>%
  filter((methylation_coexit != 1) |(methylation_coexit ==1 & Methylation != "No")) %>%
  ungroup() %>%
  dplyr::select(-methylation_coexit)

meth_per_gene <- mut_beta_sub_meth_t %>%
  group_by(Methylation) %>%
  summarise(n=n())

meth_total_tcga <- meth_per_gene[which(meth_per_gene$Methylation == "BRCA1"), "n"]+meth_per_gene[which(meth_per_gene$Methylation == "RAD51C"), "n"]
unmeth_total <- meth_per_gene[which(meth_per_gene$Methylation == "No"), "n"]
brca1me_total_tcga <- meth_per_gene[which(meth_per_gene$Methylation == "BRCA1"), "n"]
rad51cme_total_tcga <- meth_per_gene[which(meth_per_gene$Methylation == "RAD51C"), "n"]


meth_per_gene_project <- mut_beta_sub_meth_t %>%
  separate_rows(Methylation, sep = " & ") %>%
  group_by(Methylation, Project) %>%
  summarise(n=n()) %>%
  pivot_wider(names_from = "Methylation",  values_from = "n", values_fill = 0) %>%
  pivot_longer(cols = c("BRCA1", "RAD51C"), names_to = "Methylated_gene", values_to = "total_meth") %>%
  dplyr::rename(total_unmeth = No)


mut_beta_sub_meth_t_per_sample <- mut_beta_sub_meth_t %>%
  mutate(Sample.ID = if_else(Project =="OV", substr(Sample.ID, 1, 27), substr(Sample.ID, 1, 15))) %>%
  left_join(mc3_icgc %>%
              mutate(Sample.ID = if_else(startsWith(Sample.ID, "AOC"), substr(Sample.ID, 1, 27), Sample.ID)) %>%
  filter(silent_mutation == "No", Hugo_Symbol %in% oncokb_gene_list$`Hugo Symbol`)) %>%
  distinct() 

#total meth vs unmeth
# meth_unmeth_prev <- mut_beta_sub_meth_t_per_sample  %>%
#   group_by(Hugo_Symbol) %>%
#   summarise(Meth_mut = sum(Methylation != "No"),
#             Unmeth_mut = sum(Methylation == "No")) %>%
#   mutate(total_meth = unlist(meth_total_tcga), total_unmeth = unlist(unmeth_total),
#          Prevalence_Unmethylated = Unmeth_mut / total_unmeth,
#          Prevalence_Methylated = Meth_mut / total_meth ) %>%
#    group_by(Hugo_Symbol) %>%
#   mutate(fisher_p = fisher.test(matrix(c(Meth_mut, total_meth - Meth_mut , Unmeth_mut, total_unmeth - Unmeth_mut), byrow = T, ncol =2))$p) %>%
#   ungroup() %>%
#   mutate(pval.adj = p.adjust(fisher_p, method = "bonferroni")) %>%
#   mutate(pval.adj_plot = if_else(pval.adj >=0.05, "ns", "<0.05")) %>%
#   filter(!is.na(Hugo_Symbol)) %>%
#   ggplot(aes(y =Prevalence_Unmethylated, x =Prevalence_Methylated))+
#   geom_point(data = . %>%
#                 filter(pval.adj >=0.05),color = "#828181", alpha = 0.7)+
#   geom_point(data = . %>%
#                 filter(pval.adj <0.05),color = "red")+
#   geom_abline(linetype="dashed")+
#   geom_label_repel(data = .%>% filter(Prevalence_Unmethylated>0.45 |Prevalence_Methylated>0.45), aes(label = Hugo_Symbol),size = 3, fill = NA, box.padding = 0.1, label.padding = 0.1)+
#   geom_label_repel(data = .%>% filter(pval.adj <0.05), aes(label = Hugo_Symbol), colour = "red", size = 3, fill = NA, box.padding = 0.1, label.padding = 0.1)+
#   theme_bw()+
#   scale_color_manual(values = c("ns" = "#828181", "<0.05" = "red"), "adjusted p value")+
#   scale_x_continuous(paste0("Mutation Frequency in Methylated Samples (N=",unlist(meth_total_tcga),")"), limits = c(0,1), labels = scales::percent)+
#   scale_y_continuous(paste0("Mutation Frequency in Unmethylated Samples (N=",unlist(unmeth_total),")"), limits = c(0,1),labels = scales::percent)+
#   theme(legend.position = "bottom")
#ggsave(plot = meth_unmeth_prev, "plots/meth_unmeth_mutation_prevalence.pdf", device = "pdf")



#by project & gene 
type_brca1_rad51c_prev_table <- mut_beta_sub_meth_t_per_sample  %>%
  group_by(Hugo_Symbol, Project) %>%
  mutate(Unmeth_mut = sum(Methylation == "No")) %>%
  ungroup() %>%
  group_by(Hugo_Symbol, Project, Methylation) %>%
  mutate(Meth_mut = n_distinct(Sample.ID)) %>%
  ungroup()%>%
  filter(Methylation != "No") %>%
  dplyr::select(-Sample.ID, -silent_mutation) %>%
  distinct() %>%
  complete(Project, Methylation, Hugo_Symbol, fill = list(Unmeth_mut =0, Meth_mut = 0)) %>%
  dplyr::rename(Methylated_gene = Methylation) %>%
  inner_join(meth_per_gene_project %>%filter(total_meth >3), by = c("Methylated_gene", "Project")) %>%
  mutate(Prevalence_Unmethylated = Unmeth_mut/total_unmeth,
         Prevalence_Methylated = Meth_mut/total_meth) %>%
  dplyr::select(-CaseID) %>%
  distinct() %>%
  group_by(Methylated_gene, Hugo_Symbol, Project) %>%
  mutate(fisher_p =fisher.test(matrix(c(Meth_mut, total_meth - Meth_mut, Unmeth_mut, total_unmeth - Unmeth_mut), byrow = T, ncol =2))$p,
         fisher_or =fisher.test(matrix(c(Meth_mut, total_meth - Meth_mut, Unmeth_mut, total_unmeth - Unmeth_mut), byrow = T, ncol =2))$estimate) %>%
  ungroup() %>%
  group_by(Project, Methylated_gene, .keep = T) %>%
  mutate(pval.adj = p.adjust(fisher_p, method = "bonferroni")) %>%
mutate(pval.adj_plot = if_else(pval.adj >=0.05, "ns", "<0.05"))


type_brca1_rad51c_prev <- type_brca1_rad51c_prev_table%>%
  group_map(~ggplot(.x, aes(y =Prevalence_Unmethylated, x = Prevalence_Methylated))+
  geom_point(aes(color = pval.adj_plot), alpha = 0.7)+
  geom_abline(linetype="dashed")+
  geom_label_repel(data = .%>% filter(pval.adj  >= 0.05 , Hugo_Symbol %in% c("TP53", "ARID1A", "PIK3CA", "IDH1")), aes(label = Hugo_Symbol), colour = "black", size = 2, fill = NA, box.padding = 0.6, label.padding = 0.1)+
  geom_label_repel(data = .%>% filter(pval.adj <0.05), aes(label = Hugo_Symbol), colour = "red", size = 2, fill = NA, box.padding = 0.1, label.padding = 0.1)+
  theme_bw()+
  facet_wrap(~Project)+
  scale_color_manual(values = c("ns" = "#828181", "<0.05" = "red"), "adjusted p value")+
  scale_x_continuous(paste0("N = ",unique(.x$total_meth)), limits = c(0,1.05), labels = scales::percent)+
  scale_y_continuous(paste0("N = ",unique(.x$total_unmeth)),  limits = c(0,1),labels = scales::percent)+
  theme(legend.position = "none", axis.title = element_text(size = 8)), .keep = T)

#manual inspect and assign
plot_order <- c("BRCA1",rep("RAD51C",2),"BRCA1", "RAD51C","BRCA1", "RAD51C", "BRCA1")
type_brca1_rad51c_prev <- lapply(1:length(type_brca1_rad51c_prev),function(i) change_facet_strip_color(type_brca1_rad51c_prev[[i]], methylation_color[plot_order[i]]) )


type_brca1_prev <- grid.arrange(grobs = type_brca1_rad51c_prev[c(4, 6, 1, 8)], layout_matrix = rbind(c(1,2),
                                                                                c(3, 4)),left = "Mutation Frequency in Unmethylated Sample",
             bottom = "Mutation Frequency in Methylated Sample")

type_rad51c_prev <- grid.arrange(grobs = type_brca1_rad51c_prev[c(7, 5, 3, 2)], layout_matrix = rbind(c(1,2),
                                                                                c(3,4)),left = "Mutation Frequency in Unmethylated Sample",
             bottom = "Mutation Frequency in Methylated Sample")

# plot2 <- ggarrange(arrangeGrob(gene_brca1_prev), arrangeGrob(gene_rad51c_prev),
#                    arrangeGrob(type_brca1_prev),arrangeGrob(type_rad51c_prev),nrow = 2, ncol =2, labels = c("a","b","c","d"))

plot2 <- ggarrange(arrangeGrob(type_brca1_prev),arrangeGrob(type_rad51c_prev),nrow = 1, ncol =2)


ggsave(plot = plot2 , "plots/Main_Figure_3_Mutation_prevalence_by_methylation.pdf", device = "pdf", width = 250, height = 120, units= "mm")

```

##Supplementary plot 4
```{r}
#by gene
brca1_rad51c_unmeth_prev_table <- mut_beta_sub_meth_t_per_sample  %>%
  group_by(Hugo_Symbol) %>%
  summarise(BRCA1 = sum(Methylation == "BRCA1"),
            RAD51C = sum(Methylation == "RAD51C"),
            Unmeth_mut = sum(Methylation == "No"))%>%
  pivot_longer(cols = c("BRCA1", "RAD51C"), names_to= "Methylated_gene", values_to = "Meth_mut") %>%
  ungroup() %>%
  complete(Hugo_Symbol, Methylated_gene, fill = list(Unmeth_mut = 0, Meth_mut = 0)) %>%
  mutate(total_meth = if_else(Methylated_gene == "BRCA1", unlist(brca1me_total_tcga), unlist(rad51cme_total_tcga)),
         total_unmeth = unlist(unmeth_total),
         Prevalence_Unmethylated = Unmeth_mut / total_unmeth,
         Prevalence_Methylated = Meth_mut / total_meth) %>%
  group_by(Methylated_gene, Hugo_Symbol) %>%
  mutate(fisher_p = fisher.test(matrix(c(Meth_mut, total_meth - Meth_mut, Unmeth_mut, total_unmeth - Unmeth_mut), byrow = T, ncol =2))$p,
         fisher_or = fisher.test(matrix(c(Meth_mut, total_meth - Meth_mut, Unmeth_mut, total_unmeth - Unmeth_mut), byrow = T, ncol =2))$estimate) %>%
  ungroup() %>%
  group_by(Methylated_gene, .keep =T) %>%
  mutate(pval.adj = p.adjust(fisher_p, method = "bonferroni")) %>%
  mutate(pval.adj_plot = if_else(pval.adj >=0.05, "ns", "<0.05")) 



# brca1_rad51c_unmeth_prev  <- brca1_rad51c_unmeth_prev_table %>%
  group_map(~ggplot(.x, aes(y =Prevalence_Unmethylated, x = Prevalence_Methylated))+
  geom_point(aes(color = pval.adj_plot), alpha = 0.7)+
  geom_abline(linetype="dashed")+
  geom_label_repel(data = .%>% filter(pval.adj >=0.05, Hugo_Symbol %in% c("TP53", "ARID1A", "PIK3CA", "IDH1")), aes(label = Hugo_Symbol), colour = "black",size = 3, fill = NA, box.padding = 0.1, label.padding = 0.1)+
  geom_label_repel(data = .%>% filter(pval.adj <0.05), aes(label = Hugo_Symbol), colour = "red", size = 3, fill = NA, box.padding = 0.1, label.padding = 0.1)+
  theme_bw()+
  facet_wrap(~Methylated_gene, nrow = 2, scale = "free")+
  scale_color_manual(values = c("ns" = "#828181", "<0.05" = "red"), "adjusted p value")+
  scale_x_continuous(paste0("N = ",unique(.x$total_meth)), limits = c(0,1), labels = scales::percent)+
  scale_y_continuous(paste0("N = ",unique(.x$total_unmeth)), limits = c(0,1),labels = scales::percent)+
  theme(legend.position = "none",
        strip.text.x = element_text(face = "bold.italic")), .keep =T)

plot_order <- c("BRCA1","RAD51C")
brca1_rad51c_unmeth_prev <- lapply(1:length(brca1_rad51c_unmeth_prev),function(i) change_facet_strip_color(brca1_rad51c_unmeth_prev[[i]], methylation_color[plot_order[i]]) )

gene_brca1_prev <- grid.arrange(grobs = brca1_rad51c_unmeth_prev[1], nrow = 1,left = "Mutation Frequency in Unmethylated Sample",
             bottom = "Mutation Frequency in Methylated Sample")

gene_rad51c_prev <- grid.arrange(grobs = brca1_rad51c_unmeth_prev[2], nrow = 1,left = "Mutation Frequency in Unmethylated Sample",
             bottom = "Mutation Frequency in Methylated Sample")
plot2 <- ggarrange(arrangeGrob(gene_brca1_prev), arrangeGrob(gene_rad51c_prev))
ggsave(plot = plot2, filename = "plots/Supplementary/Sup4_gene_comutation.pdf", width = 250, height = 120, units= "mm" )
```

##Supplementary Table 6 Mutation fisher
```{r}
write_tsv(brca1_rad51c_unmeth_prev_table %>%
            filter(Methylated_gene == "BRCA1") %>%
             dplyr::select(Hugo_Symbol, Unmeth_Mut = Unmeth_mut, Meth_Mut = Meth_mut, Total_Unmeth = total_unmeth, Total_meth = total_meth, Prevalence_Unmethylated, Prevalence_Unmethylated, fisher_p, pval.adj, fisher_or), "data/supplementary_data/Table_S6_mutation_by_BRCA1.tsv")

write_tsv(brca1_rad51c_unmeth_prev_table %>%
            filter(Methylated_gene == "RAD51C") %>%
             dplyr::select(Hugo_Symbol, Unmeth_Mut = Unmeth_mut, Meth_Mut = Meth_mut, Total_Unmeth = total_unmeth, Total_meth = total_meth, Prevalence_Unmethylated, Prevalence_Unmethylated, fisher_p, pval.adj, fisher_or), "data/supplementary_data/Table_S6_mutation_by_RAD51C.tsv")

write_tsv(type_brca1_rad51c_prev_table %>%
            filter(Methylated_gene == "BRCA1") %>%
            dplyr::select(Dataset = Project, Hugo_Symbol, Unmeth_Mut = Unmeth_mut, Meth_Mut = Meth_mut, Total_Unmeth = total_unmeth, Total_meth = total_meth, Prevalence_Unmethylated, Prevalence_Unmethylated, fisher_p, pval.adj, fisher_or), "data/supplementary_data/Table_S6_mutation_by_project_BRCA1.tsv")

write_tsv(type_brca1_rad51c_prev_table %>%
            filter(Methylated_gene == "RAD51C") %>%
            dplyr::select(Dataset = Project, Hugo_Symbol, Unmeth_Mut = Unmeth_mut, Meth_Mut = Meth_mut, Total_Unmeth = total_unmeth, Total_meth = total_meth, Prevalence_Unmethylated, Prevalence_Unmethylated, fisher_p, pval.adj, fisher_or), "data/supplementary_data/Table_S6_mutation_by_project_RAD51C.tsv")

```


# Main figure 5 - expression
```{r}
 #assessed no dup in Sample.ID, 1 per gene
  mRNA_expr <-  beta_sub_meth_mrna_t %>%
  filter(Project != "MESO", !is.na(mRNA_norm_counts)) %>%
  mutate(Sample.ID = substr(Sample.ID, 1, 12)) %>%
  dplyr::select(gene, Project, Methylation, Sample.ID, mRNA_norm_counts) %>%
  distinct() %>%
  group_by(gene, Project, Methylation) %>%
  mutate(number = paste0( "N=", n())) %>%
  ungroup() %>%
  group_by(gene, Project) %>%
  filter(sum(Methylation!= "No") >0) %>%
  group_by(gene, .keep =T) %>%
  mutate(Project = factor(Project, levels = c("OV","TGCT", "STAD", "LGG", "BC", "SKCM", "UCEC", "GBM","LIHC","COAD", "HNSC","LUSC","THCA","PAAD","ESCA","CESC","KIRC", "BLCA","LUAD")),
         Methylation = factor(Methylation, levels = c("Yes", "No")))%>%
  group_map(.f =  ~ ggplot(.x %>%
                             mutate(), aes(x = Project, y = mRNA_norm_counts, color = Methylation))+
  geom_point(position = position_jitterdodge(dodge.width = 1.2,jitter.width = 0.35), size = 0.5) +
     geom_boxplot(data = .x %>% filter(Methylation == "No"),position = position_nudge(x = 0.3),outlier.shape = NA, width = 0.3, color = "#828181", fill = NA)+
  geom_boxplot(data = .x %>% group_by(Project, Methylation) %>% filter(Methylation != "No", n()>2)%>% ungroup(),position = position_nudge(x = -0.3),outlier.shape = NA, width = 0.3, fill = NA)+
  ylab("log2 ( CPM )") +
  geom_text(data = .x %>%
              filter(Methylation == "No") %>%
              dplyr::select(Project, Methylation, number) %>%
              distinct(), mapping = aes( y =-0.6, label = number), position = position_nudge(x = 0.3), color = "black", size = 2)+
    geom_text(data = .x %>%
              filter(Methylation != "No") %>%
              dplyr::select(Project, Methylation, number) %>%
              distinct(), mapping = aes( y =-0.6, label = number), position = position_nudge(x = -0.3), color = "black", size = 2)+
  theme_bw()+
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),axis.ticks.x = element_blank(),
        legend.key.size = unit(0.5, 'cm'),legend.position = "bottom", 
        legend.margin = margin(0,0,0,0), legend.box.margin=margin(-10,0,0,0),legend.justification = "top",
        strip.placement = "outside", strip.background = element_rect(fill = "white", colour = "white"), 
        panel.border = element_rect(colour = "grey", fill = NA), panel.spacing = unit(0.2,'lines'),
        plot.margin = margin(0.8, 0.2, 0.2, 0.2, "cm"),
        panel.grid.major.x = element_blank()) +
  facet_grid( cols = vars(Project) , space = "free", switch = "x", scale = "free_x", margins = F)+
  ylim(-0.7,9)+
  {if (.y[1]== "BRCA1") { scale_color_manual(values = methylation_color_brca1, "BRCA1 Methylation" )}
    else {scale_color_manual(values = methylation_color_rad51c, "RAD51C Methylation")}} +
  stat_compare_means(data = .x %>% group_by(Project, gene) %>%
                     filter(sum(Methylation == "Yes")>2) %>%
                    ungroup() %>% group_by(Project) %>%
                      filter(n_distinct(Methylation) > 1), label = "p.format", label.y = 8, hide.ns =T, size = 2), keep =T)
  ggarrange(mRNA_expr[[1]]+ theme(axis.title.x = element_blank()),
            mRNA_expr[[2]], align = "h",nrow = 2, labels = c("a", "b"))
ggsave("plots/Main_Figure_5_expression_of_RAD51C_BRCA1.pdf", device = "pdf", width = 10, height = 6 )


#plot mRNA
BRCA2_sample  <- beta_sub %>%
  filter(gene_promo_200 == "BRCA2") %>%
  group_by(Sample.ID) %>%
  summarise(avg_meth = mean(beta)) %>%
  filter(avg_meth > 0.4) %>%
  pull(Sample.ID)
BRCA2_mRNA_table <- mRNA %>%
  filter(Project %in% c("TCGA-BRCA"), Sample_Group == "Primary Tumor") %>%
  dplyr::select(mRNA_norm_counts = ENSG00000139618.16, Sample.ID) %>%
  mutate(Project = "BC",
         gene = "BRCA2",
         Methylation = if_else(Sample.ID %in% BRCA2_sample, "Yes", "No"),
          Methylation = factor(Methylation, levels = c("Yes", "No"))) 
 
  
  BRCA2_mRNA<- BRCA2_mRNA_table %>%  group_by(gene, Project, Methylation) %>%
  mutate(number = paste0( "N=", n())) %>%
  ungroup() %>%
  ggplot(aes(x = Project, y = mRNA_norm_counts, color = Methylation))+
   geom_point(position = position_jitterdodge(dodge.width = 1.2,jitter.width = 0.35), size = 0.9) +
  geom_boxplot(data = . %>% filter(Methylation == "No"),position = position_nudge(x = 0.3),outlier.shape = NA, width = 0.3, color = "#828181", fill = NA)+
  geom_boxplot(data = . %>% group_by(Project, Methylation) %>% filter(Methylation != "No", n()>2)%>% ungroup(),position = position_nudge(x = -0.3),outlier.shape = NA, width = 0.3)+
  ylab("log2 ( CPM )") +
  theme_bw()+
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),axis.ticks.x = element_blank(),
        legend.key.size = unit(0.5, 'cm'),legend.position = "bottom", 
        legend.margin = margin(0,0,0,0), legend.box.margin=margin(-10,0,0,0),legend.justification = "top",
        strip.placement = "outside", strip.background = element_rect(fill = "white", colour = "white"), 
        panel.border = element_rect(colour = "grey", fill = NA), panel.spacing = unit(0.2,'lines'),
        plot.margin = margin(0.8, 0.2, 0.2, 0.2, "cm"),
        panel.grid.major.x = element_blank())+
  facet_grid( cols = vars(Project),  space = "free", switch = "x", scale = "free_x", margins = F)+
  scale_color_manual(values = c("No" = "grey", "Yes" = "#FAA613"), "BRCA2 Methylation")+
  ylim(-2,9)+
  geom_text(data = . %>%
              filter(Methylation == "No") %>%
              dplyr::select(Project, Methylation, number) %>%
              distinct(), mapping = aes( y =-1.8, label = number), position = position_nudge(x = 0.3), color = "black", size = 2.5)+
    geom_text(data = . %>%
              filter(Methylation != "No") %>%
              dplyr::select(Project, Methylation, number) %>%
              distinct(), mapping = aes( y =-1.8, label = number), position = position_nudge(x = -0.3), color = "black", size = 2.5)
   
  
# PALB2
  PALB2_sample  <- beta_sub %>%
  filter(gene_promo_200 == "PALB2") %>%
  group_by(Sample.ID) %>%
  summarise(avg_meth = mean(beta)) %>%
  filter(avg_meth > 0.25) %>%
  pull(Sample.ID)
PALB2_mRNA_table <- mRNA %>%
  filter(Project %in% c("TCGA-LUSC"), Sample_Group == "Primary Tumor") %>%
  dplyr::select(mRNA_norm_counts = ENSG00000083093.10, Sample.ID) %>%
  mutate(Project = "LUSC",
         gene = "PALB2",
         Methylation = if_else(Sample.ID %in% PALB2_sample, "Yes", "No"),
          Methylation = factor(Methylation, levels = c("Yes", "No"))) 
 
  
  PALB2_mRNA<- PALB2_mRNA_table %>%  group_by(gene, Project, Methylation) %>%
  mutate(number = paste0( "N=", n())) %>%
  ungroup() %>%
  ggplot(aes(x = Project, y = mRNA_norm_counts, color = Methylation))+
   geom_point(position = position_jitterdodge(dodge.width = 1.2,jitter.width = 0.35), size = 0.9) +
  geom_boxplot(data = . %>% filter(Methylation == "No"),position = position_nudge(x = 0.3),outlier.shape = NA, width = 0.3, color = "#828181", fill = NA)+
  geom_boxplot(data = . %>% group_by(Project, Methylation) %>% filter(Methylation != "No", n()>2)%>% ungroup(),position = position_nudge(x = -0.3),outlier.shape = NA, width = 0.3)+
  ylab("log2 ( CPM )") +
  theme_bw()+
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),axis.ticks.x = element_blank(),
        legend.key.size = unit(0.5, 'cm'),legend.position = "bottom", 
        legend.margin = margin(0,0,0,0), legend.box.margin=margin(-10,0,0,0),legend.justification = "top",
        strip.placement = "outside", strip.background = element_rect(fill = "white", colour = "white"), 
        panel.border = element_rect(colour = "grey", fill = NA), panel.spacing = unit(0.2,'lines'),
        plot.margin = margin(0.8, 0.2, 0.2, 0.2, "cm"),
        panel.grid.major.x = element_blank())+
  facet_grid( cols = vars(Project),  space = "free", switch = "x", scale = "free_x", margins = F)+
  scale_color_manual(values = c("No" = "grey", "Yes" = "#D90368"), "PALB2 Methylation")+
  ylim(-2,9)+
  geom_text(data = . %>%
              filter(Methylation == "No") %>%
              dplyr::select(Project, Methylation, number) %>%
              distinct(), mapping = aes( y =-1.8, label = number), position = position_nudge(x = 0.3), color = "black", size = 2.5)+
    geom_text(data = . %>%
              filter(Methylation != "No") %>%
              dplyr::select(Project, Methylation, number) %>%
              distinct(), mapping = aes( y =-1.8, label = number), position = position_nudge(x = -0.3), color = "black", size = 2.5)
   
# load cesc mRNA for plotting
mRNA_CESC <- map_dfr(Sys.glob("data/side_project/TCGA_CESC_mRNA_edgeR.csv"), ~as.data.frame(t(data.frame(data.table::fread(.x, header = T, na.string = "", fill = T), row.names = 1)))%>%
  mutate(File.Name = gsub(".rna_seq.augmented_star_gene_counts.tsv", "", gsub("^X", "", rownames(.)))))%>%
  left_join(mRNA_sample %>%
               mutate(File.Name = gsub("-", ".",gsub(".rna_seq.augmented_star_gene_counts.tsv", "", File.Name))) %>%
             dplyr::select(File.Name, Sample.ID, Project, Sample_Group ) , by = "File.Name")


BRIP1_sample <- beta_sub %>%
  filter(gene_promo_200 == "BRIP1") %>%
  group_by(Sample.ID) %>%
  summarise(avg_meth = mean(beta)) %>%
  filter(avg_meth > 0.4) %>%
  pull(Sample.ID)

BRIP1_mRNA_table <- rbind(mRNA%>%
  filter(Project %in% c("TCGA-CESC", "TCGA-LIHC", "TCGA-UCEC"), Sample_Group == "Primary Tumor") %>%
  dplyr::select(mRNA_norm_counts = ENSG00000136492.9, Sample.ID, Project),
  mRNA_CESC %>%
  filter(Sample_Group == "Primary Tumor") %>%
  dplyr::select(mRNA_norm_counts = ENSG00000136492.9, Sample.ID, Project)) %>%
  mutate(Project = gsub("TCGA-", "", Project),
         gene = "BRIP1",
         Methylation = if_else(Sample.ID %in% BRIP1_sample, "Yes", "No"),
          Methylation = factor(Methylation, levels = c("Yes", "No"))) 
BRIP1_mRNA <- BRIP1_mRNA_table %>%
  group_by(gene, Project, Methylation) %>%
  mutate(number = paste0( "N=", n())) %>%
  ungroup() %>%
  ggplot(aes(x = Methylation, y = mRNA_norm_counts, color = Methylation))+
   geom_point(position = position_jitterdodge(dodge.width = 1.2,jitter.width = 0.35), size = 0.9) +
  geom_boxplot(data = . %>% filter(Methylation == "No"),outlier.shape = NA, width = 0.3, color = "#828181", fill = NA)+
  geom_boxplot(data = . %>% group_by(Project, Methylation) %>% filter(Methylation != "No", n()>2)%>% ungroup(),position = position_nudge(x = -0.3),outlier.shape = NA, width = 0.3)+
  ylab("log2 ( CPM )") +
  theme_bw()+
 theme(axis.title.x = element_blank(), axis.text.x = element_blank(),axis.ticks.x = element_blank(),
        legend.key.size = unit(0.5, 'cm'),legend.position = "bottom", 
        legend.margin = margin(0,0,0,0), legend.box.margin=margin(-10,0,0,0),legend.justification = "top",
        strip.placement = "outside", strip.background = element_rect(fill = "white", colour = "white"), 
        panel.border = element_rect(colour = "grey", fill = NA), panel.spacing = unit(0.2,'lines'),
        plot.margin = margin(0.8, 0.2, 0.2, 0.2, "cm"),
        panel.grid.major.x = element_blank())+
  facet_grid( cols = vars(Project), space = "free", switch = "x", scale = "free_x", margins = F)+
  scale_color_manual(values = c("No" = "grey", "Yes" = "#4F4789"), "BRIP1 Methylation")+
   ylim(-2,9)+
  geom_text(data = . %>%
              filter(Methylation == "No") %>%
              dplyr::select(Project, Methylation, number) %>%
              distinct(), mapping = aes( y =-1.8, label = number), position = position_nudge(x = 0.2), color = "black", size = 2.5)+
    geom_text(data = . %>%
              filter(Methylation != "No") %>%
              dplyr::select(Project, Methylation, number) %>%
              distinct(), mapping = aes( y =-1.8, label = number), position = position_nudge(x = -0.2), color = "black", size = 2.5)


ggarrange(BRIP1_mRNA, BRCA2_mRNA,PALB2_mRNA , widths = c(0.45, 0.3, 0.3), common.legend = F,  align = "v",ncol = 3, labels = c("c", "d", "e"))
ggsave(filename = "plots/Main_Figure_5_BRIP1_BRCA2_PALB2_mRNA.pdf",  height = 3*1.2, width = 10*1.2)
```




#Main figure 6 -HRD
```{r}
hrd_plot_df <- hrd_predictors   %>%
  filter(!is.na(Sig3), !is.na(HRD_Score)) %>%
  separate_rows(Methylation, sep = " & ") %>%
   mutate(Methylation = case_when(Sample.ID == "TCGA-E2-A1LA-01" ~"BRCA2",
                                  Sample.ID %in% c("TCGA-C5-A2LT-01","TCGA-CC-A3MA-01","TCGA-SL-A6JA-01","TCGA-AJ-A8CW-01") ~ "BRIP1",
                                  Sample.ID == "TCGA-77-7142-01" ~ "PALB2",
                                  TRUE ~ Methylation)) %>%
  group_by(Project) %>%
  filter(sum(Methylation != "No") >=1) %>%
  ungroup() %>%
  mutate(Methylation = factor(Methylation, levels = c("BRCA1", "RAD51C", "BRCA2", "BRIP1", "PALB2", "No")),
  Project = factor(Project, levels = c("OV","TGCT", "STAD", "LGG", "BC", "SKCM", "UCEC", "GBM","LIHC","COAD", "HNSC","LUSC","THCA","PAAD","ESCA","CESC","KIRC", "BLCA","LUAD")),
  project_number = as.integer(Project))%>%
  pivot_longer(cols = c(Sig3, HRD_Score), names_to = "Predictor", values_to = "value")%>%
  group_by(Project, Methylation, Predictor) %>%
  mutate(Methylation_N = paste0("N=", n())) %>%
  ungroup() %>%
  mutate(Methylation_N = factor(Methylation_N, levels =  unique(Methylation_N[order(Methylation)])))

stat.test <- hrd_plot_df %>%
  group_by(Project, Methylation, Predictor, .keep = T) %>%
  filter(n() >2, !is.na(value)) %>%
  ungroup() %>%
  compare_means(value ~ Methylation, data =., group.by = c("Project", "Predictor"), ref.group = "No") %>%
  left_join(hrd_plot_df %>%
              group_by(Project,  Predictor, .keep = T) %>%
              summarise(y.position = max(value, na.rm =T)) %>%
              ungroup() %>%
              dplyr::select(Project, Predictor, y.position)) %>%
  mutate(p.adj = if_else(p.adj >= 0.05, "ns", as.character(p.adj))) %>%
  group_by(Project, Predictor) %>%
  mutate(y.position = if_else(Predictor == "HRD_Score", 100-(100- y.position*0.9 -2)/n()*row_number(),  1-(1- 1.1 * y.position)/n()*row_number()))   %>%
  ungroup()

sig_plot_df  <- hrd_plot_df %>%
  ungroup() %>%
  filter(Predictor == "Sig3")


sig_plot <- sig_plot_df %>%
  ggplot(aes(x = Methylation, y = value, color =Methylation))+
   geom_point(position = position_jitterdodge(jitter.width = 0.8), size = 0.8)+
  geom_boxplot(outlier.shape = NA, data = . %>% ungroup()%>% group_by(Project, Methylation, .keep = T) %>%
                 filter(n() >2) %>% ungroup() , alpha = 0)+
   geom_text(data = sig_plot_df %>%
              dplyr::select(Project, Methylation, Methylation_N) %>%
              distinct(), mapping = aes( y =-0.05, label = Methylation_N), color = "black", size = 2.5)+
  theme_bw()+
  scale_color_manual(values= methylation_color_extended, limits = force)+
  scale_y_continuous("%SNV Sig3 Explained", limits = c(-0.05,1), labels = scales::percent)+
  theme(legend.position = "none", strip.text.y = element_blank(), axis.title.x = element_blank(),
        strip.background = element_rect(fill = "white", colour = "black"),
        axis.text.x = element_text(angle = 45, hjust =1))+
  facet_grid(cols = vars(Project), rows = vars(Predictor), scales = "free", space = "free")+
    stat_pvalue_manual(stat.test%>%
                         filter(Predictor == "Sig3") , label = "p.adj", tip.length = 0)+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 5))

score_plot_df <- hrd_plot_df %>%
  ungroup() %>%
  filter(Predictor == "HRD_Score")


hrd_plot <- score_plot_df %>%
  ggplot(aes(x = Methylation, y = value, color =Methylation))+
  geom_point(position = position_jitterdodge(jitter.width = 0.8), size = 0.8)+
  geom_boxplot(outlier.shape = NA, data = . %>% ungroup()%>% group_by(Project, Methylation, .keep = T) %>%
  filter(n() >2) %>% ungroup(), alpha = 0)+
  theme_bw()+
  geom_hline(yintercept = 42, linetype = 3)+
   geom_text(data = sig_plot_df %>%
              dplyr::select(Project, Methylation, Methylation_N) %>%
              distinct(), mapping = aes( y =-5, label = Methylation_N), color = "black", size = 2.5)+
  scale_color_manual(values= methylation_color_extended, limits = force)+
  scale_y_continuous("HRD Score", limits = c(-5, 102))+
  theme(strip.text.y = element_blank(), axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
                    axis.text.y = element_text(hjust=1.2),strip.background = element_rect(fill = "white", colour = "black"))+
  facet_grid(cols = vars(Project), rows = vars(Predictor), scales = "free", space = "free")+
    stat_pvalue_manual(stat.test%>%
  filter(Predictor == "HRD_Score"), label = "p.adj", tip.length = 0)+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 5))


ggarrange(hrd_plot, sig_plot,common.legend = T, legend = "bottom", nrow =2, align = "v")
ggsave("plots/Main_Figure_6_hrd_predictor.pdf", device = "pdf", height = 7, width = 16)
```


##Supplementary plot 5 HRD score and expression
```{r}
explore_df <- hrd_plot_df %>%
  left_join(purity) %>%
  left_join(beta_sub_meth %>%
              filter(!is.na(PredefinedCpG), Sample_Group =="Primary Tumor")%>%
              group_by(gene, Project, Sample.ID) %>%
              summarise(avg_meth = mean(beta)) %>%
              mutate(Sample.ID = if_else(Project == "OV", Sample.ID, substr(Sample.ID, 1, 15))) %>%
              ungroup(), by = c("Methylation" = "gene", "Project", "Sample.ID")) %>%
  left_join(beta_sub_meth_mrna_t %>%
              dplyr::select(gene, Project, Sample.ID,mRNA_norm_counts) %>%
              distinct() %>%
              mutate(Sample.ID = if_else(Project == "OV", Sample.ID, substr(Sample.ID, 1, 15)))) %>%
  left_join(cn_purity_adj_beta %>%
              group_by(Project, gene, Sample.ID_original, CN) %>%
              summarise(avg_corr_meth= mean(mt_cap)) %>%
              ungroup() %>%
              mutate(Sample.ID = if_else(Project == "OV", Sample.ID_original, substr(Sample.ID_original, 1, 15)))%>%
              dplyr::select(-Project, -Sample.ID_original)) %>%
  left_join(mc3_gene)%>%
  filter(Predictor == "HRD_Score") %>%
  dplyr::select(-starts_with("Sig")) %>%
  group_by(Project, gene) %>%
  mutate( zscore = (mRNA_norm_counts - mean(mRNA_norm_counts, na.rm = T)) /sd(mRNA_norm_counts, na.rm = T))%>%
  ungroup() %>%
  filter(Methylation != "No", Methylation == gene) %>%
  dplyr::rename(HRD_Score = value) 


fit_brca1 <- lm(HRD_Score ~ avg_meth, data = explore_df %>%
             filter(Methylation == "BRCA1"), weights = purity)  

sink("data/supplementary_data/Sup_Data_1_BRCA1_regression.txt")
print(summary(fit_brca1))
sink()

fit_rad51c <- lm(HRD_Score ~ avg_meth, data = explore_df %>%
             filter(Methylation == "RAD51C"), weights = purity)  

sink("data/supplementary_data/Sup_Data_2_RAD51C_regression.txt")
print(summary(fit_rad51c))
sink()


hrd_regression <- explore_df %>%
  group_by(Methylation) %>%
  group_map(~ ggplot(.x, aes(x =avg_meth, y = HRD_Score, color = Methylation, alpha = purity))+
  geom_point()+
  stat_smooth(method = "lm", aes(weight = purity)) +
  ylim(0,100)+
  scale_color_manual(values =methylation_color)+
  theme_bw()+ 
    facet_wrap(~Methylation)+
  theme(aspect.ratio = 1)+
     scale_alpha_continuous(range = c(0.4, 1))+
  xlab("Average Methylation")+
  ylab("HRD Score"), .keep =T)


hrd_regression<- lapply(1:length(hrd_regression),function(i) change_facet_strip_color(hrd_regression[[i]], methylation_color[c("BRCA1", "RAD51C")[i]]) )

 ggarrange(arrangeGrob(hrd_regression[[1]]),arrangeGrob(hrd_regression[[2]]))
ggsave("plots/Supplementary/Sup5_hrd_regression.pdf", height =4, width = 8)

```
##Supplementary Table 7 HRD feature stats
```{r}
write.csv(stat.test %>%
            filter(Predictor == "Sig3") %>%
             dplyr::select(Project, group2, pvalue =p, pvalue.adj = p.adj), "data/supplementary_data/Table_S7_Sig3.csv", quote = F, row.names = F)

write.csv(stat.test %>%
            filter(Predictor == "HRD_Score") %>%
             dplyr::select(Project, group2, pvalue =p, pvalue.adj = p.adj), "data/supplementary_data/Table_S7_HRD_Score.csv", quote = F, row.names = F)

```


```{r}
library(GGally)

legend <- grab_legend(explore_df %>%
                        dplyr::rename(Dataset = Project ) %>%
                        filter(Methylation == "BRCA1")%>%
                        group_by(Dataset) %>%
                        filter(n() >2) %>%
                        mutate(Dataset = factor(Dataset, levels= c("OV","TGCT", "STAD", "LGG", "BC", "UCEC", "COAD", "HNSC"))) %>%
                        ggplot(aes(x = HRD_Score, y = zscore))+
                        geom_point(shape = 21, aes(fill = Dataset))+
                        scale_fill_brewer(palette="Set1", drop=FALSE))


explore_df %>%
  mutate(TP53 = if_else(TP53 != "", "Yes", "No" ))%>%
  filter(Methylation == "BRCA1")%>%
  dplyr::rename(`HRD Score`= HRD_Score, `Expression (z-score)` = zscore, `Avg Methylation (corrected)` = avg_corr_meth, `Avg Methylation` = avg_meth) %>%
  group_by(Project) %>%
  filter(n()>2) %>%
  ungroup() %>%
  mutate(Project = factor(Project, levels= c("OV","TGCT", "STAD", "LGG", "BC", "UCEC", "COAD", "HNSC"))) %>%
ggpairs( columns = c("HRD Score", "Expression (z-score)", "Avg Methylation"), diag = list(continuous = "blankDiag"), aes(fill = Project,  shape = Methylation, size = 0.8,  alpha = 0.8), legend =legend, lower = list(continuous = "points", combo = "facethist", discrete = "facetbar", na =
    "na"), upper = list(continuous = "blank", combo = "facethist", discrete = "facetbar", na =
    "na"))+
  theme_bw()+
  scale_shape_manual(values = c(21))+
  
  scale_fill_brewer(palette="Set1",  drop=FALSE)

ggsave("plots/Supplementary/Sup5_BRCA1_HRD.pdf", height = 10, width = 10)



legend <- grab_legend(explore_df %>%
                        dplyr::rename(Dataset = Project ) %>%
                        filter(Methylation == "RAD51C")%>%
                        group_by(Dataset) %>%
                        filter(n() >2) %>%
                        mutate(Dataset = factor(Dataset, levels= c("OV","TGCT", "STAD", "LGG", "BC", "UCEC", "COAD", "HNSC"))) %>%
                        ggplot(aes(x = HRD_Score, y = zscore))+
                        geom_point(shape = 21, aes(fill = Dataset))+
                        scale_fill_brewer(palette="Set1", drop=FALSE))


explore_df %>%
  mutate(TP53 = if_else(TP53 != "", "Yes", "No" ))%>%
  filter(Methylation == "RAD51C")%>%
  dplyr::rename(`HRD Score`= HRD_Score, `Expression (z-score)` = zscore, `Avg Methylation (corrected)` = avg_corr_meth, `Avg Methylation` = avg_meth) %>%
  group_by(Project) %>%
  filter(n()>2) %>%
  ungroup() %>%
  mutate(Project = factor(Project, levels= c("OV","TGCT", "STAD", "LGG", "BC", "UCEC", "COAD", "HNSC"))) %>%
ggpairs( columns = c("HRD Score", "Expression (z-score)", "Avg Methylation"), diag = list(continuous = "blankDiag"), aes(fill = Project,  shape = Methylation, size = 0.8, alpha = 0.8), legend =legend, lower = list(continuous = "points", combo = "facethist", discrete = "facetbar", na =
    "na"), upper = list(continuous = "blank", combo = "facethist", discrete = "facetbar", na =
    "na"))+
  theme_bw()+
  scale_shape_manual(values = c(21))+
  scale_fill_brewer(palette="Set1",  drop=FALSE)

ggsave("plots/Supplementary/Sup5_RAD51C_HRD.pdf", height = 10, width = 10)




```
## Main Figure 6 Oncoprint
```{r}
ICGC_CURRATED_HR_MUT <- read_xlsx("data/supporting/nature14410-Supplementary_Table_4.xlsx",sheet = 2, skip =1) %>%
  filter(startsWith(`Study ID`, "AOCS"), `Collection point` =="Primary") %>%
  mutate(`Study ID` = gsub("-", "_", substr(`Study ID`, 1,8)))


HRD_onco <- beta_sub_meth_t%>%
  filter(Methylation != "No") %>%
  group_by(Sample.ID) %>%
  mutate(Methylation = paste(gene, collapse = "&")) %>%
  ungroup() %>%
  dplyr::select(-gene) %>%
  mutate(Sample.ID_original = if_else(Project =="OV", Sample.ID,substr(Sample.ID, 1, 15)),
    Sample.ID = if_else(Project =="OV", substr(Sample.ID, 1, 27),substr(Sample.ID, 1, 15))) %>%
  left_join(mc3_gene %>%
              ungroup() %>%
              distinct() %>%
              mutate(Sample.ID = if_else(startsWith(Sample.ID, "AOC"), substr(Sample.ID, 1, 27), Sample.ID))) %>%
  distinct() %>%
  left_join(hrd_predictors %>%
              ungroup()  %>%
              dplyr::select(-c("Methylation", "Project")) , by = c("Sample.ID_original" = "Sample.ID")) %>%
  
  mutate(DonorID = if_else(Project == "OV", substr(Sample.ID, 1, 8), substr(Sample.ID, 1, 12)),
         BRCA1 = if_else(substr(Sample.ID, 1, 8) %in% unlist(ICGC_CURRATED_HR_MUT[which(ICGC_CURRATED_HR_MUT$Genea == "BRCA1"), "Study ID"]), "MUT;Conseq", BRCA1),
          BRCA2 = if_else(substr(Sample.ID, 1, 8) %in% unlist(ICGC_CURRATED_HR_MUT[which(ICGC_CURRATED_HR_MUT$Genea == "BRCA2"), "Study ID"]), "MUT;Conseq", BRCA2)) %>%
  group_by(DonorID) %>%
  slice(1) %>%
  ungroup() %>%
  filter(Methylation != "No", Project %in% c("OV", "STAD","LGG","BC", "UCEC", "COAD", "LUSC", "HNSC" ), !is.na(HRD_Score)) %>%
  dplyr::select(Project, Methylation, Sample.ID_original,DonorID, TP53, BRCA1, RAD51C, BRCA2, BRIP1, PALB2, HRD_Score, Sig3) %>%
  left_join(purity, by = c("Sample.ID_original" = "Sample.ID")) %>%
  left_join(beta_sub_meth %>%
              filter(!is.na(PredefinedCpG), Sample_Group =="Primary Tumor")%>%
              group_by(gene, Project, Sample.ID) %>%
              summarise(avg_meth = mean(beta)) %>%
              mutate(Sample.ID = if_else(Project == "OV", Sample.ID, substr(Sample.ID, 1, 15))) %>%
              ungroup(), by = c("Methylation" = "gene", "Project", "Sample.ID_original" = "Sample.ID")) %>%
  left_join(cn_purity_adj_beta %>%
              group_by(gene, Sample.ID_original, CN) %>%
              summarise(avg_corr_meth= mean(mt_cap)) %>%
              ungroup(), by = c("Methylation" = "gene", "Sample.ID_original")) %>%
  mutate(Project = factor(Project, levels = c("OV", "STAD","LGG","BC", "UCEC", "COAD", "LUSC", "HNSC" )),
           project_number = as.numeric(Project)) %>%
  distinct() %>%
  arrange(Project, Methylation, -HRD_Score) %>%
  mutate(number = row_number()) 


HRD_onco_mat <- HRD_onco%>%
  t()


colnames(HRD_onco_mat) <- unlist(HRD_onco$"DonorID")



HRD_onco_plot <- oncoPrint(HRD_onco_mat[c("TP53", "BRCA1", "BRCA2", "RAD51C", "BRIP1", "PALB2"),],
  alter_fun = alter_fun,
  show_pct = FALSE,
  row_names_side = "left",
top_annotation =HeatmapAnnotation(
    Project = anno_block(labels= c("OV","STAD","LGG","BC", "UCEC", "COAD", "LUSC", "HNSC"),labels_gp = gpar(fontsize = 10)),
     Methylation = HRD_onco_mat["Methylation",], 
    `HRD Score` = as.numeric(HRD_onco_mat["HRD_Score",]),
    `Signature 3` = as.numeric(HRD_onco_mat["Sig3",]),
    `Avg Meth` = anno_points(apply((matrix(HRD_onco_mat[c("avg_meth","avg_corr_meth"),],nc =2, byrow = T)),2, as.numeric),
                             pch = c(21,3), gp = gpar(col = c("#E69F00","#0072B2")),show_annotation_name = F, ylim = c(0,1), height = unit(6, "lines")),
     Purity = as.numeric(HRD_onco_mat["purity",]),
    `Copy Number\n(gene)` = as.numeric(HRD_onco_mat["CN",]),
    
    annotation_name_rot = 0,
    annotation_name_gp = gpar(fontsize= 10),
    annotation_name_side = "left",
    col = list(Methylation = methylation_color_ht, `HRD Score` = HRD_color,
               `Signature 3` = signature_color, `Copy Number\n(gene)` = CN, Purity = Purity),
     gp = gpar(col = "white"),
    simple_anno_size = unit(1.5, "cm"),
    annotation_legend_param = list(`HRD Score` = list(at = c(0, 42, 100), labels =c(0, 42, 100)),
                                   `Signature 3` = list(at = c(0, 0.1, 1), labels =c(0, 0.1, 1)))),
    column_title = NULL, column_order = as.numeric(HRD_onco_mat["number",]),
  column_split = HRD_onco_mat["project_number",],
  heatmap_legend_param = list(direction = "horizontal",title = "Somatic Variants"),
show_column_names = T)


lgd = Legend(labels = c("Raw", "Corrected"), legend_gp = gpar(col = c("#E69F00","#0072B2")), pch = c(21,3), type = "points", title = "Avg Meth")

 pdf("plots/Main_Figure_6b_oncoprint_methylated.pdf", height = 12,width = 18)
  # pdf("oncoprint_methylated_level.pdf", height = 8.3,width = 15)

draw(HRD_onco_plot, annotation_legend_side = "bottom", heatmap_legend_side = "bottom", merge_legend = TRUE, annotation_legend_list = lgd)
decorate_annotation("Avg Meth", {
 grid.lines(seq(0.5, ncol(HRD_onco_mat)+3), c(0.2, 0.2), default.units = "native", gp = gpar(lty = 3,lwd=1))
})
dev.off()

```
##Source data 10 HRD_oncoprint
```{r}
write.csv(HRD_onco%>%
            filter(Methylation == "BRCA1") %>%
            dplyr::select(-Sample.ID_original, -number, -project_number) %>%
            dplyr::rename(BRCA1_avg_corr_meth = avg_corr_meth, BRCA1_CN = CN), "data/source_data/Source_Data_10_HRD_oncoprint_BRCA1.csv", quote = F, row.names = F)

write.csv(HRD_onco%>%
            filter(Methylation == "RAD51C") %>%
            dplyr::select(-Sample.ID_original, -number, -project_number) %>%
            dplyr::rename(RAD51C_avg_corr_meth = avg_corr_meth, RAD51C_CN = CN), "data/source_data/Source_Data_10_HRD_oncoprint_RAD51C.csv", quote = F, row.names = F)
 
```
#Main plot 7-DEPMAP
## Main plot 7 expression
```{r}
depmap_mRNA <- fread("data/processed/depmap_brett/RAD51C_methylation_gene_expression.csv")

depmap_mRNA %>%
  mutate(cluster = case_when(cluster == "no methylation" ~ "No Methylation",
                             Cell_name == "SNU601" ~ "Homozygous RAD51Cme",
                             TRUE ~ "Heterozygous RAD51Cme"),
         cluster = factor(cluster, levels = c("Homozygous RAD51Cme", "Heterozygous RAD51Cme","No Methylation"))) %>%
  ggplot(aes(x = cluster, y = rad51c_exp, color = cluster))+
  geom_beeswarm(size = 1,cex = 2)+
    geom_boxplot(data =.%>%
                 group_by(cluster) %>%
                 filter(n()>1) %>%
                 ungroup(), outlier.shape = NA, fill = NA)+
  theme_bw()+
  stat_compare_means(comparisons = list(c("Heterozygous RAD51Cme", "No Methylation")))+
  theme(axis.title.x = element_blank(), legend.position = "none")+
    ylab("RAD51C Expression log2(CPM)")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  ylim(-4, 7)+
  scale_color_manual(values = RAD51C_het_hom)

  ggsave("plots/Main_Figure_7_depmap_expression.pdf", height = 3, width = 6)
```

## Main plot 7 Oncoprint
```{r}
gene_list = c("TP53", "PIK3CA", "IDH1", "ARID1A", "PTEN", "NUMA1", "CIC")

cell_ancestry <- fread("data/processed/depmap_brett/NIHMS1032762-supplement-Suppl_Table_1.csv") 

```
##depmap mutation release
```{r}
depmap_model <- fread("data/processed/depmap_brett/Model_23Q2_0523.csv") %>%
  filter(str_detect(CCLEName, "STOMACH"))
mutation_depmap <- fread("data/processed/depmap_brett/OmicsSomaticMutations_23Q2_0523.csv")
mutation_depmap <- mutation_depmap %>%
  filter(HugoSymbol %in% c(hr_gene_list, "TP53", "PIK3CA", 
                           "ARID1A")) %>%
  right_join(depmap_model %>%
               dplyr::select(ModelID, Sample.ID = StrippedCellLineName)) %>%
  filter(Sample.ID %in% depmap_mRNA$Cell_name, !VariantInfo %in% c("INTRON", "FIVE_PRIME_FLANK", "THREE_PRIME_UTR" ,"SILENT"))

#run this code if no annotation generated
#clinvar annotation
# cat("##fileformat=VCFv4.1\n##contig=<ID=1,length=249250621,assembly=b38>\n##reference=file:///path/to/human_g1k_v38.fasta\n",
#     append=FALSE,
#         file= "data/processed/VCF/depmap_variants_hg38.vcf")
# 
# HR_tp53_vcf <- mutation_depmap %>%
#                        mutate(`#CHROM` = as.numeric(gsub("chr", "", Chrom)),
#                               POS = Pos,
#                               ID = ".",
#                               REF = Ref,
#                               ALT =Alt,
#                               QUAL = ".",
#                               FILTER = "PASS",
#                               INFO = ".") %>%
#                        select(`#CHROM`,POS,ID,REF,ALT,QUAL,FILTER,INFO) %>%
#   arrange(`#CHROM`, POS) %>%
#   distinct()
# 
# fwrite(HR_tp53_vcf,
#        append=TRUE,
#        sep="\t",
#        col.names = T,
#        file="data/processed/VCF/depmap_variants_hg38.vcf")

depmap_clinvar <-  as.data.frame(fread("data/processed/VCF/depmap_variants_hg38.vcf.vep102.tsv",skip = "#Uploaded_variation", header = T, sep = "\t", na.string = "-"))%>%
     select(1:3,5,7:8,
           # Add symbol
           SYMBOL,
           EXON,
           matches("HGVS(c|p)"),
           matches("^gnomADe_non_cancer_(AC$|AF$|AN$|nhomalt$|faf95$)"),
           matches("^gnomADe_non_cancer_(AC|AF|AN|nhomalt|faf95).*(eas$|sas$)"),
           matches("^1000Gp1_(AC$|AF$)"),
           matches("^1000Gp1_ASN_(AC$|AF$)"),
           matches("^ClinVar", ignore.case = F))


mutation_depmap %<>%
  mutate(Chrom = gsub("chr", "", Chrom),
         `#Uploaded_variation` = paste0(Chrom, "_", Pos, "_", Ref, "/", Alt)) %>%
  dplyr::select( `#Uploaded_variation` , AF, RefCount, AltCount, VariantType, HugoSymbol, CosmicHotspot, Sample.ID, VariantInfo) %>%
  left_join(depmap_clinvar %>%
              dplyr::rename(HugoSymbol =SYMBOL) %>%
              dplyr::select(-Consequence, -cDNA_position, -EXON, -HGVSc, -HGVSp, -Feature) %>%
              distinct())



depmap_clinvar_mat <- mutation_depmap%>%
  mutate(mutation = case_when(str_detect(VariantInfo, "MISSENSE") ~ "Missense",
                              str_detect(VariantInfo, "FRAME_SHIFT") ~"Frameshift",
                              str_detect(VariantInfo, "SPLICE") ~"Splice Site",
                              str_detect(VariantInfo, "IN_FRAME") ~"In Frame",
                              str_detect(VariantInfo, "NONSENSE") ~"Nonsense",
                              str_detect(VariantInfo, "START") ~"Start Site")) %>%
  mutate(mutation_label = if_else(str_detect(ClinVar_CLNSIG, fixed("Pathogenic", ignore_case = T))
                            & !(str_detect(ClinVar_CLNSIG, fixed("Conflicting" , ignore_case = T)))
                            & !is.na(ClinVar_CLNSIG), paste(mutation, "ClinVar P/LP", sep = ";"),
                            mutation),
         ClinVar_CLNSIG = factor(ClinVar_CLNSIG, levels = c("Pathogenic","Pathogenic/Likely_pathogenic","Likely_pathogenic",
                                                            "Conflicting_interpretations_of_pathogenicity","Uncertain_significance","Benign")),
          mutation = factor(mutation, levels = c( "Frameshift", "Nonsense", "Start Site","Splice Site", "Nonstop", "In Frame", "Missense"))) %>%
  dplyr::select(Sample.ID, HugoSymbol, mutation, ClinVar_CLNSIG, mutation_label) %>%
  distinct() %>%
  group_by(Sample.ID, HugoSymbol) %>%
  arrange( ClinVar_CLNSIG, mutation) %>%
  slice(1) %>%
  ungroup() %>%
  dplyr::select(Sample.ID, HugoSymbol, mutation_label) %>%
  pivot_wider(names_from = HugoSymbol, values_from = mutation_label)

depmap_clinvar_mat[hr_gene_list[which(!hr_gene_list %in% colnames(depmap_clinvar_mat))]] = NA

```
##Main plot 7 drug sensitivity
```{r}
```

##Supplementary plot 6 other HR gene 
```{r}
hr_gene_meth <- fread("data/processed/depmap_brett/avg_gene_meth_33_stad_lines_200bp.csv") %>%
  dplyr::select(-V1) %>%
  left_join(rad51c_depmap %>%
              dplyr::select(Cell_line = Sample.ID, level)) %>%
  pivot_longer(cols =contains("_avg_meth"), names_to ="HR gene", values_to = "Averaged Methylation" ) %>%
  mutate(`HR gene` = toupper(gsub("_avg_meth", "", `HR gene`))) %>%
  group_by(`HR gene`) %>%
  mutate(label = paste0(`HR gene`, " (N=", n(), ")")) %>%
  ungroup()

hr_gene_meth %>%
  ggplot(aes(x = label, y = `Averaged Methylation`)) +
  geom_beeswarm()+
  ylim(c(0,1))+
  theme_bw()+
  geom_hline(yintercept = 0.2,linetype = "dashed")+
  ylab(paste0("Averaged Methylation ( ","", "200bps TSS)"))+
  geom_label_repel(data = .%>%
                     filter(`Averaged Methylation` > 0.2), aes(label = Cell_line))+
  theme(axis.title.x = element_blank())

ggsave("plots/Supplementary/Sup7_depmap_hr_gene.pdf", height = 4, width = 7)

setdiff(unique(rad51c_depmap$Sample.ID),unique(hr_gene_meth$Cell_line))

```
##Main Figure 7d HRD
```{r}
rad51c_depmap %>%
   mutate(level = factor(level, levels = c("Homozygous RAD51Cme", "Heterozygous RAD51Cme","No Methylation"))) %>%
  ggplot(aes(y= HRD_Score, x = level, color = level))+
   geom_beeswarm(size = 1,cex = 2)+
  geom_boxplot(outlier.shape = NA, data = . %>% ungroup()%>% group_by(level, .keep = T) %>%
                 filter(n() >2) %>% ungroup() , alpha = 0)+
  theme_bw()+
  scale_color_manual(values= RAD51C_het_hom, limits = force)+
  scale_y_continuous("HRD score", limits = c(0, 100))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  theme(legend.position = "none", strip.text.y = element_blank(), axis.title.x = element_blank(),
        strip.background = element_rect(fill = "white", colour = "black"))

  ggsave("plots/Main_Figure_7_depmap_hrd.pdf", height = 3, width = 6)
```
#Source data Main Figure
```{r}
write.csv(beta_sub_meth_t %>%
            filter(gene == "BRCA1") %>%
            dplyr::select(gene, Project, Methylation, Sample.ID) %>%
            distinct(), "data/source_data/figure_1a.csv", quote = F, row.names = F)

write.csv(beta_sub_meth_t %>%
            filter(gene == "RAD51C") %>%
            dplyr::select(gene, Project, Methylation, Sample.ID) %>%
            distinct(), "data/source_data/figure_1b.csv", quote = F, row.names = F)


write.csv(TCGA_subtype %>%
            filter(Project %in% c("TGCT", "STAD", "LGG", "BC", "UCEC")) %>%
              dplyr::select(Project, Methylation, Sample.ID, `Cancer Type Detailed`) %>%
            distinct(), "data/source_data/figure_1c.csv", quote = F, row.names = F)

write.csv(TCGA_subtype %>%
            filter(Project %in% c("OV", "STAD", "LGG", "BC", "UCEC")) %>%
              dplyr::select(Project, Methylation, Sample.ID, Subtype) %>%
            distinct(), "data/source_data/figure_1d.csv", quote = F, row.names = F)


write.csv(demograph_table_meth %>%
  mutate(Dataset = factor(Dataset, levels = c("OV","TGCT", "STAD", "LGG", "BC", "SKCM", "UCEC", "GBM","LIHC","COAD", "HNSC","LUSC","THCA","PAAD","ESCA","CESC","KIRC", "BLCA","LUAD")),
         stage = gsub("Stage ", "", stage),
          Methylation = factor(Methylation, levels= c("BRCA1", "RAD51C", "BRCA1 & RAD51C", "No"))) %>%
  group_by(Dataset,  stage) %>%
  mutate(total =n()) %>%
  ungroup() %>%
  group_by(Dataset, Methylation, stage, total) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  group_by(Methylation, Dataset) %>%
  filter(sum(n)>2) %>%
  ungroup() %>%
   group_by(Dataset) %>%
  filter(n_distinct(Methylation) >1  & n_distinct(stage )>1) , "data/source_data/figure_2a.csv", quote = F, row.names = F)

write.csv(age_DF, "data/source_data/figure_2b.csv", quote = F, row.names = F)


write.csv(demograph_table_meth %>%
   separate_rows(Methylation, sep = " & ") %>%
   group_by(Dataset, Methylation, consensus_ancestry) %>%
  summarise(n=n()) %>%
  ungroup() %>%
   mutate(level = case_when(Methylation == "BRCA1" ~ 1,
                            Methylation == "RAD51C" ~ 2,
                            Methylation == "No" ~ 3)) %>%
   group_by(Methylation,Dataset) %>%
  filter(sum(n)>2) %>%
   mutate(Methylation = paste0(Methylation, " (N=",sum(n),")", sep = "")) %>%
  ungroup() %>%
  group_by(Dataset) %>%
  filter(n_distinct(Methylation) >1, n_distinct(consensus_ancestry) >1) %>%
   ungroup() %>%
  group_by(Dataset) %>%
  filter(n_distinct(Methylation)>1, Dataset != "OV") %>%
  ungroup() , "data/source_data/figure_2c.csv", quote = F, row.names = F)

write.csv(TCGA_subtype %>%
  filter(Project %in% c("STAD", "LGG")) %>%
  dplyr::select(Project, Sample.ID, Methylation, cimp_label) %>%
    distinct(), "data/source_data/figure_3a.csv", quote = F, row.names = F)


write.csv(TCGA_subtype %>%
  filter(!Project %in% c("STAD", "LGG")) %>%
  dplyr::select(Project, Sample.ID, Methylation, Cluster) %>%
    distinct(), "data/source_data/figure_3b.csv", quote = F, row.names = F)


write.csv(type_brca1_rad51c_prev_table %>%
            filter(Methylated_gene == "BRCA1"), "data/source_data/figure_4a.csv", quote = F, row.names = F)


write.csv(type_brca1_rad51c_prev_table %>%
            filter(Methylated_gene == "RAD51C"), "data/source_data/figure_4b.csv", quote = F, row.names = F)

# write.csv(oncoprint_matrix, "data/source_data/figure_4c.csv", quote = F, row.names = F)

write.csv( beta_sub_meth_mrna_t %>%
  filter(Project != "MESO", !is.na(mRNA_norm_counts)) %>%
  dplyr::select(gene, Project, Methylation, Sample.ID, mRNA_norm_counts) %>%
  distinct() %>%
  group_by(gene, Project, Methylation) %>%
  mutate(number = paste0( "N=", n())) %>%
  ungroup() %>%
  group_by(gene, Project) %>%
  filter(sum(Methylation!= "No") >0) %>%
    ungroup() %>%
    filter(gene == "BRCA1") %>%
    dplyr::select(-number), "data/source_data/figure_5a.csv", quote = F, row.names = F)

write.csv(beta_sub_meth_mrna_t %>%
  filter(Project != "MESO", !is.na(mRNA_norm_counts)) %>%
  dplyr::select(gene, Project, Methylation, Sample.ID, mRNA_norm_counts) %>%
  distinct() %>%
  group_by(gene, Project, Methylation) %>%
  mutate(number = paste0( "N=", n())) %>%
  ungroup() %>%
  group_by(gene, Project) %>%
  filter(sum(Methylation!= "No") >0) %>%
    ungroup() %>%
    filter(gene == "RAD51C") %>%
    dplyr::select(-number) , "data/source_data/figure_5b.csv", quote = F, row.names = F)

write.csv(BRIP1_mRNA_table, "data/source_data/figure_5c.csv", quote = F, row.names = F)

write.csv(BRCA2_mRNA_table, "data/source_data/figure_5d.csv", quote = F, row.names = F)

write.csv(PALB2_mRNA_table, "data/source_data/figure_5e.csv", quote = F, row.names = F)

write.csv(sig_plot_df %>%
            dplyr::select(Project, Methylation, Sample.ID, Mutation_Signature_3 = value), "data/source_data/figure_6a.csv", quote = F, row.names = F)

write.csv(score_plot_df%>%
            dplyr::select(Project, Methylation, Sample.ID, HRD_Score = value), "data/source_data/figure_6b.csv", quote = F, row.names = F)


write.csv( , "data/source_data/figure_7b.csv", quote = F, row.names = F)

write.csv(depmap_mRNA %>%
  mutate(cluster = case_when(cluster == "no methylation" ~ "No Methylation",
                             Cell_name == "SNU601" ~ "Homozygous RAD51Cme",
                             TRUE ~ "Heterozygous RAD51Cme"),
         cluster = factor(cluster, levels = c("Homozygous RAD51Cme", "Heterozygous RAD51Cme","No Methylation"))), "data/source_data/figure_7c.csv", quote = F, row.names = F)

write.csv(, , "data/source_data/figure_7d.csv", quote = F, row.names = F)


```
#Source data Supp Figure
```{r}
write.csv(beta_sub %>%filter(Sample_Group %in% c("Primary Tumor", "Solid Tissue Normal"), !is.na(gene_promo_200), gene_promo_200 != "CHEK2"),
          "data/source_data/supplementary_figure_1.csv", quote = F, row.names = F)


write.csv(beta_sub_ht %>%
  dplyr::select(CaseID, chr_start, beta, Project) %>%
  distinct()%>%
  filter(Project %in% c("OV", "TGCT", "STAD", "BC", "LGG","UCEC", "LUSC", "THCA")), "data/source_data/supplementary_figure_2.csv", quote = F, row.names = F)

write.csv(beta_sub %>%
  filter( Project %in% c("CESC", "LIHC", "UCEC"), Sample_Group %in% c("Primary Tumor", "Solid Tissue Normal"), gene_promo_200 == "BRIP1") %>%
    mutate(CpG = factor(CpG, levels = unique(beta_sub$CpG[order(beta_sub$chr_start)])), gene2=gene) , "data/source_data/supplementary_figure_3a.csv", quote = F, row.names = F)

write.csv(beta_sub %>%
  filter( Project %in% c("BC"), Sample_Group %in% c("Primary Tumor", "Solid Tissue Normal"), gene_promo_200 == "BRCA2")%>%
    mutate(CpG = factor(CpG, levels = unique(beta_sub$CpG[order(beta_sub$chr_start)])), gene2=gene) , "data/source_data/supplementary_figure_3b.csv", quote = F, row.names = F)

write.csv(beta_sub %>%
  filter( Project %in% c("LUSC"), Sample_Group %in% c("Primary Tumor", "Solid Tissue Normal"), gene_promo_200 == "PALB2") %>%
    mutate(CpG = factor(CpG, levels = unique(beta_sub$CpG[order(beta_sub$chr_start)])), gene2=gene) , "data/source_data/supplementary_figure_3c.csv", quote = F, row.names = F)


write.csv(oncoprint_matrix, "data/source_data/supplementary_figure_4.csv", quote = F, row.names = F)

write.csv(explore_df %>%
            dplyr::select(Project, Methylation, Sample.ID, purity, HRD_Score, avg_meth), "data/source_data/supplementary_figure_5a.csv", quote = F, row.names = F)

write.csv(explore_df %>%
            dplyr::select(Project, Methylation, Sample.ID, purity, HRD_Score, avg_meth, zscore), "data/source_data/supplementary_figure_5b.csv", quote = F, row.names = F)

```


#Data and Figures not included

##Supplementary table 
```{r sample avilability for each assay}
# patient ID list in each assay
mRNA = c(unlist(mRNA_sample$`Case ID`), unlist(mRNA_sample_ICGC$donorLabel))

cn = c(unlist(copy_number_sample$`Case ID`), unlist(copy_number_sample_ICGC$Patient.ID))

maf = c(unlist(maf_sample$`Case ID`), unlist(maf_sample_ICGC$`Case ID`))

# plot data availability
data_availability <- Deduplicated_beta %>%
  filter(Sample_Group == "Primary Tumor") %>%
  mutate(Patient.ID = substr(Patient.ID, 1, 12)) %>%
  dplyr::select(Project, Patient.ID) 
data_availability$Methylation = data_availability$Patient.ID %in% data_availability$Patient.ID
data_availability$mRNA = data_availability$Patient.ID %in% mRNA
data_availability$`Copy Number` = data_availability$Patient.ID %in% cn
data_availability$Mutation = data_availability$Patient.ID %in% maf

data_availability %>%
  column_to_rownames("Patient.ID") 


```


##Supplementary plot  - EBV
```{r}

#stomach 
TCGA_subtype %>%
  filter(Project == "STAD") %>%
  dplyr::select(STAD_subtype =Subtype, cimp_label, Methylation, Sample.ID) %>%
  mutate(cimp_label = factor(cimp_label, levels = c("CIMP+", "CIMP-")),
         STAD_subtype = factor(STAD_subtype, levels = c("CIN", "EBV", "GS", "MSI", "POLE"))) %>%
  filter(!is.na(STAD_subtype)) %>%
  group_by(cimp_label, STAD_subtype) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  complete(cimp_label, STAD_subtype,
           fill = list(n = 0)) %>%
  fisher.test(x = t(matrix(.$n,byrow = T, nrow = 2))) -> fisher_output

TCGA_subtype %>%
  filter(Project == "STAD") %>%
  dplyr::select(STAD_subtype=Subtype, cimp_label, Methylation, Sample.ID, Project) %>%
  mutate(cimp_label = factor(cimp_label, levels = c("CIMP+", "CIMP-"))) %>%
  filter(!is.na(STAD_subtype)) %>%
  ggplot(aes(x = STAD_subtype, fill = cimp_label)) +
  geom_bar(position = "stack", colour = "black", size = 0.2)+
  scale_fill_manual(values = col$"CIMP", limits = force, "CIMP subtype")+
  theme_bw()+
  annotate("text",x = "MSI", y= 190, label= paste0("Fisher's exact \n p-value =",signif(fisher_output$p.value,2)))+
  theme(legend.position = "bottom")+
  scale_y_continuous("CIMP Subtype Distribution (count)")+
  scale_x_discrete("Molecular Subtype")+
  facet_wrap(~Project)

ggsave("plots/Supplementary/Sup6_cimpvsEBV_stad.pdf", device = "pdf", height = 4, width = 8)

TCGA_subtype %>%
  filter(Project == "STAD") %>%
  dplyr::select(STAD_subtype =Subtype, cimp_label, Methylation, Sample.ID) %>%
  mutate(cimp_label = factor(cimp_label, levels = c("CIMP+", "CIMP-"))) %>%
  filter(!is.na(cimp_label)) %>%
  group_by(cimp_label, Methylation) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  complete(cimp_label, Methylation,
           fill = list(n = 0)) %>%
  fisher.test(x = t(matrix(.$n,byrow = T, nrow = 3))) -> fisher_output

TCGA_subtype %>%
  filter(Project == "STAD") %>%
  dplyr::select(STAD_subtype=Subtype, cimp_label, Methylation, Sample.ID, Project) %>%
  mutate(cimp_label = factor(cimp_label, levels = c("CIMP+", "CIMP-"))) %>%
  filter(!is.na(cimp_label)) %>%
  group_by(Methylation) %>%
  mutate(Methylation = paste0(Methylation, " (N=", n(), ")"),
         Methylation = factor(Methylation, levels = c("BRCA1 (N=1)", "RAD51C (N=28)","No (N=366)"))) %>%
  ggplot(aes(x = Methylation, fill = cimp_label)) +
  geom_bar(position = "fill", colour = "black", size = 0.2)+
  scale_fill_manual(values = col$"CIMP", limits = force, "CIMP subtype")+
  theme_bw()+
  annotate("text",x = "RAD51C (N=28)", y= 1.1, label= paste0("Fisher's exact \n p-value =",signif(fisher_output$p.value,2)))+
  theme(legend.position = "bottom")+
  scale_y_continuous("CIMP Subtype Distribution (percent)", labels = scales::percent, limits = c(0,1.2))+
  scale_x_discrete("Methylation")+
  facet_wrap(~Project)
ggsave("plots/Supplementary/Sup6_cimpvsMe_stad.pdf", device = "pdf", height = 4, width = 8)


#breast
TCGA_subtype %>%
  filter(Project == "BC") %>%
  dplyr::select(STAD_subtype =Subtype, cimp_label, Methylation, Sample.ID) %>%
  mutate(cimp_label = factor(cimp_label, levels = c("CIMP+", "CIMP-", "CIMPi"))) %>%
  filter(!is.na(cimp_label)) %>%
  group_by(cimp_label, Methylation) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  complete(cimp_label, Methylation,
           fill = list(n = 0)) %>%
  fisher.test(x = t(matrix(.$n,byrow = T, nrow = 3))) -> fisher_output

TCGA_subtype %>%
  filter(Project == "BC") %>%
  dplyr::select(STAD_subtype=Subtype, cimp_label, Methylation, Sample.ID, Project) %>%
  mutate(cimp_label = factor(cimp_label, levels = c("CIMP+", "CIMP-", "CIMPi"))) %>%
  filter(!is.na(cimp_label)) %>%
  group_by(Methylation) %>%
  mutate(Methylation = paste0(Methylation, " (N=", n(), ")"),
         Methylation = factor(Methylation, levels = c("BRCA1 (N=14)", "RAD51C (N=19)","No (N=749)"))) %>%
  ggplot(aes(x = Methylation, fill = cimp_label)) +
  geom_bar(position = "fill", colour = "black", size = 0.2)+
  scale_fill_manual(values = col$"CIMP", limits = force, "CIMP subtype")+
  theme_bw()+
  annotate("text",x = "RAD51C (N=19)", y= 1.1, label= paste0("Fisher's exact \n p-value =",signif(fisher_output$p.value,2)))+
  theme(legend.position = "bottom")+
  scale_y_continuous("CIMP Subtype Distribution (percent)", labels = scales::percent, limits = c(0,1.2))+
  scale_x_discrete("Methylation")+
  facet_wrap(~Project)

ggsave("plots/Supplementary/Sup6_cimpvsMe_bc.pdf", device = "pdf", height = 4, width = 8)



TCGA_subtype %>%
  filter(Project == "TGCT") %>%
  separate_rows(Methylation, sep = " & ") %>%
  dplyr::select(STAD_subtype =Subtype, cimp_label, Methylation, Sample.ID) %>%
  mutate(cimp_label = factor(cimp_label, levels = c("CIMP+", "CIMP-"))) %>%
  filter(!is.na(cimp_label)) %>%
  group_by(cimp_label, Methylation) %>%
  summarise(n=n_distinct(Sample.ID)) %>%
  ungroup() %>%
  complete(cimp_label, Methylation,
           fill = list(n = 0)) %>%
  fisher.test(x = t(matrix(.$n,byrow = T, nrow = 2))) -> fisher_output

TCGA_subtype %>%
  filter(Project == "TGCT") %>%
  separate_rows(Methylation, sep = " & ") %>%
  dplyr::select(STAD_subtype=Subtype, cimp_label, Methylation, Sample.ID, Project) %>%
  mutate(cimp_label = factor(cimp_label, levels = c("CIMP+", "CIMP-"))) %>%
  filter(!is.na(cimp_label)) %>%
  group_by(Methylation) %>%
  # mutate(Methylation = paste0(Methylation, " (N=", n(), ")"),
  #        Methylation = factor(Methylation, levels = c("BRCA1 (N=14)", "RAD51C (N=19)","No (N=749)"))) %>%
  ggplot(aes(x = Methylation, fill = cimp_label)) +
  geom_bar(position = "fill", colour = "black", size = 0.2)+
  scale_fill_manual(values = col$"CIMP", limits = force, "CIMP subtype")+
  theme_bw()+
  annotate("text",x = "RAD51C", y= 1.1, label= paste0("Fisher's exact \n p-value =",signif(fisher_output$p.value,2)))+
  theme(legend.position = "bottom")+
  scale_y_continuous("CIMP Subtype Distribution (percent)", labels = scales::percent, limits = c(0,1.2))+
  scale_x_discrete("Methylation")+
  facet_wrap(~Project)


TCGA_subtype %>%
  filter(Project == "STAD", !is.na(TP53)) %>%
  group_by(cimp_label, Methylation) %>%
  summarise(PIK3CA = sum(PIK3CA != "")/n_distinct(Sample.ID),
            ARID1A = sum(ARID1A != "")/n_distinct(Sample.ID))
  

```

##Supplementary Table 8 -TMB_MSI_ANEUP
```{r}
write.csv(mutation_burden  %>%
            mutate(CaseID = if_else(Project == "OV", substr(Sample.ID,1,8), substr(Sample.ID, 1, 12) ))  %>%
            group_by(parameter_name, CaseID) %>%
  slice(1) %>%
  ungroup() %>%
            dplyr::select(parameter_name, value, Project, CaseID) %>%
            distinct() %>%
            pivot_wider(names_from = "parameter_name", values_from = value) , "data/supplementary_data/Table_S8_tmb_msi_aneu.csv", quote = F, row.names = F)
write.csv(stat.test %>%
            dplyr::select(Dataset = Project, parameter_name, group1, group2, p, p.adj), "data/supplementary_data/Table_S8_tmb_msi_stats.csv", quote = F, row.names = F)
```


##Supplementary Table 6 -HRD
```{r}
write.csv(hrd_predictors  %>%
            filter(!is.na(HRD_Score), !is.na(Sig3),Project != "TGCT") %>%
  group_by(Project) %>%
  filter(sum(Methylation != "No") >2) %>%
  ungroup() %>%
    mutate(CaseID = if_else(Project == "OV", substr(Sample.ID,1,8), substr(Sample.ID, 1, 12) )) %>%
    dplyr::rename(Dataset = Project) %>%
    dplyr::select(-Sample.ID) %>%
    distinct(), "data/supplementary_data/Table_S6_HRD_predictor.csv", quote = F, row.names = F)
write.csv(stat.test %>%
            dplyr::select(Dataset = Project, Predictor, group1, group2, p, p.adj), "data/supplementary_data/Table_S6_HRD_predictor_stats.csv", quote = F, row.names = F)
```
##Supplementary Table 7 - mutation,corrected beta
```{r}
write.csv(HRD_onco %>%
    mutate(CaseID = if_else(Project == "OV", substr(Sample.ID_original,1,8), substr(Sample.ID_original, 1, 12) )) %>%
      dplyr::select(Dataset = Project, Methylation, CaseID, TP53, BRCA1, RAD51C, BRCA2, BRIP1, PALB2, purity, CN, avg_meth, avg_corr_meth), "data/supplementary_data/Table_S7_mutation_and_corrected_methylation.csv", quote = F, row.names = F)
```
##Supplementary plot 7 - effect of TP53
```{r}
as.data.frame(t(HRD_onco)) %>%
  mutate(methylation_level = paste(avg_meth, avg_corr_meth,sep =  ", "), 
         correction = "Raw Methylation, Corrected Methylation",
         Methylation = gsub("me", " methylated", Methylation)) %>%
  dplyr::select(-avg_meth, -avg_corr_meth) %>%
  separate_rows(c(methylation_level, correction), sep = ", ") %>%
  mutate(HRD_Score = as.numeric(HRD_Score),
         methylation_level = as.numeric(methylation_level),
         correction = factor(correction, levels = c("Raw Methylation", "Corrected Methylation"))) %>%
  ggplot(aes(x = methylation_level, y = HRD_Score, color = TP53)) +
  geom_point()+
   geom_smooth(method='lm')+
  facet_grid(cols = vars(Methylation), rows = vars(correction))+
  stat_cor()+
  theme_bw()+
  theme(legend.position = "bottom")+
  xlab("Average Methylation Level at +-200 bps from Promoter")+
  ylab("HRD Score")
ggsave("plots/Supplementary/Sup7a_HRD_TP53.pdf", height = 10, width = 10)


as.data.frame(t(HRD_onco)) %>%
  mutate(methylation_level = paste(avg_meth, avg_corr_meth,sep =  ", "), 
         correction = "Raw Methylation, Corrected Methylation",
         Methylation = gsub("me", " methylated", Methylation)) %>%
  dplyr::select(-avg_meth, -avg_corr_meth) %>%
  separate_rows(c(methylation_level, correction), sep = ", ") %>%
  mutate(HRD_Score = as.numeric(HRD_Score),
         methylation_level = as.numeric(methylation_level),
         correction = factor(correction, levels = c("Raw Methylation", "Corrected Methylation")),
         Sig3 = as.numeric(Sig3)) %>%
  ggplot(aes(x = methylation_level, y = Sig3, color = TP53)) +
  geom_point()+
   geom_smooth(method='lm')+
  facet_grid(cols = vars(Methylation), rows = vars(correction))+
  stat_cor()+
  theme_bw()+
  theme(legend.position = "bottom")+
  xlab("Average Methylation Level at +-200 bps from Promoter")+
  ylab("Proportion of SNV explained by Signature3")
ggsave("plots/Supplementary/Sup7b_HRD_TP53.pdf", height = 10, width = 10)

```
##Supplementary table  - effect of TP53
```{r}

hrd_lm <- cn_purity_adj_beta  %>%
  dplyr::select(Sample_Name, Sample_Group, Project, Sample.ID, Sample.ID_original, CN, purity) %>%
  distinct() %>%
  left_join(mc3_gene) %>%
  left_join(hrd_plot_df %>%
              filter(Predictor == "HRD_Score" ) %>%
              mutate(Sample.ID = if_else(Project == "OV", substr(Sample.ID,1, 27), Sample.ID)) %>%
              dplyr::select(Sample.ID, Methylation, HRD_Score = value) %>%
              
              group_by(Sample.ID) %>%
             mutate(HRD_Score = mean(HRD_Score)) %>%
              ungroup()%>%
              distinct() ) %>%
  mutate(Project = factor(Project, levels = c("OV","TGCT", "STAD", "LGG", "BC","SKCM", "GBM", "UCEC",  "LIHC","COAD", "LUSC","THCA","HNSC","PAAD","ESCA","CESC","KIRC", "BLCA","LUAD")),
         TP53 = if_else(str_detect(TP53, "MUT"), "Yes", "No"),
         TP53 = factor(TP53, levels = c("No", "Yes")),
         caseID = if_else(Project =="OV", substr(Sample.ID, 1, 8), Sample.ID))%>%
  filter(!is.na(Project)) %>%
  left_join(mRNA %>% mutate(MKI67 = if_else(Project == "OV", ENSG00000148773,ENSG00000148773.14),
                            caseID = if_else(Project =="OV", substr(Sample.ID, 1, 8), substr(Sample.ID, 1, 15)))%>%
                  dplyr::select(MKI67, caseID) %>%
              distinct()) 

plot(fit)
fit <- lm(HRD_Score ~TP53 + CN + MKI67 +purity +Project , data = hrd_lm)
summary(fit)
```


##Supplementary plot 6 TMB MSI Aneup (removed)
```{r}
mutation_burden <- mutation_burden%>%
  filter(!is.na(value)) %>%
  separate_rows(Methylation, sep = " & ") %>%
   mutate(Methylation = case_when(Sample.ID == "TCGA-E2-A1LA-01" ~"BRCA2",
                                  Sample.ID %in% c("TCGA-C5-A2LT-01","TCGA-CC-A3MA-01","TCGA-SL-A6JA-01","TCGA-AJ-A8CW-01") ~ "BRIP1",
                                  Sample.ID == "TCGA-77-7142-01" ~ "PALB2",
                                  TRUE ~ Methylation)) %>%
  group_by(Project) %>%
  filter(sum(Methylation != "No") >=1) %>%
  ungroup() %>%
  mutate(Methylation = factor(Methylation, levels = c("BRCA1", "RAD51C", "BRCA2", "BRIP1", "PALB2", "No")),
  Project = factor(Project, levels = c("OV","TGCT", "STAD", "LGG", "BC", "SKCM", "UCEC", "GBM","LIHC","COAD", "HNSC","LUSC","THCA","PAAD","ESCA","CESC","KIRC", "BLCA","LUAD")),
  project_number = as.integer(Project))%>%
  group_by(Project, Methylation, parameter_name) %>%
  mutate(Methylation_N = paste0("N=", n())) %>%
  ungroup() 

stat.test <- mutation_burden %>%
  group_by(Project, Methylation, parameter_name, .keep = T) %>%
  filter(n() >2, !is.na(value)) %>%
  ungroup() %>%
  compare_means(value ~ Methylation, data =., group.by = c("Project", "parameter_name"), ref.group = "No") %>%
  left_join(mutation_burden  %>%
              group_by(Project,  parameter_name, .keep = T) %>%
              summarise(y.position = max(value, na.rm =T)) %>%
              ungroup() %>%
              dplyr::select(Project, parameter_name, y.position)) %>%
  mutate(p.adj = if_else(p.adj >= 0.05, "ns", as.character(p.adj))) %>%
  group_by(Project, parameter_name) %>%
  mutate(y.position = if_else(Project == "TGCT" & parameter_name != "Aneuploidy_Score", 1-(1-y.position)/n()*row_number()*8, 1-1.1*(1-y.position)/n()*row_number()))   %>%
  ungroup() %>%
mutate(y.position = case_when(parameter_name == "TMB_nonsilent" ~ log2(y.position),
                              parameter_name == "Aneuploidy_Score" & group2 == "BRCA1" ~ y.position+16,
                              TRUE ~ y.position))


msi_plot_df  <-  mutation_burden%>%
  ungroup() %>%
  filter(parameter_name == "MSI_Score") 


msi_plot <- msi_plot_df  %>%
  dplyr::select(Methylation, Sample.ID, value, parameter_name, Methylation_N, Project) %>%
  distinct() %>%
  ggplot(aes(x = Methylation, y = value, color =Methylation))+
   geom_point(position = position_jitterdodge(jitter.width = 1), size = 0.8)+
  geom_boxplot(outlier.shape = NA, data = . %>% ungroup()%>% group_by(Project, Methylation, .keep = T) %>%
                 filter(n() >2) %>% ungroup() , alpha = 0)+
   geom_text(data = msi_plot_df  %>%
              dplyr::select(Project, Methylation, Methylation_N) %>%
              distinct(), mapping = aes( y =-3, label = Methylation_N), color = "black", size = 2.5)+
  theme_bw()+
  scale_color_manual(values= methylation_color_extended, limits = force)+
  scale_y_continuous("MSI Score")+
  theme(legend.position = "none", strip.text.y = element_blank(), axis.title.x = element_blank(),
        strip.background = element_rect(fill = "white", colour = "black"),
        axis.text.x = element_text(angle = 45, hjust =1))+
  facet_grid(cols = vars(Project), rows = vars(parameter_name), scales = "free", space = "free")+
    stat_pvalue_manual(stat.test %>%
  filter(parameter_name == "MSI_Score"),  label = "p.adj", tip.length = 0)+
  geom_hline(yintercept =15, linetype = "dotted")

tmb_plot_df <- mutation_burden%>%
  ungroup() %>%
  filter(parameter_name == "TMB_nonsilent")  %>%
  mutate(value = log2(value))


tmb_plot <- tmb_plot_df  %>%
  dplyr::select(Methylation, Sample.ID, value, parameter_name, Methylation_N, Project) %>%
  distinct() %>%
  ggplot(aes(x = Methylation, y = value, color =Methylation))+
   geom_point(position = position_jitterdodge(jitter.width = 1), size = 0.8)+
  geom_boxplot(outlier.shape = NA, data = . %>% ungroup()%>% group_by(Project, Methylation, .keep = T) %>%
                 filter(n() >2) %>% ungroup() , alpha = 0)+
   geom_text(data = tmb_plot_df  %>%
              dplyr::select(Project, Methylation, Methylation_N) %>%
              distinct(), mapping = aes( y =-5.5, label = Methylation_N), color = "black", size = 2.5)+
  theme_bw()+
  scale_color_manual(values= methylation_color_extended, limits = force)+
  scale_y_continuous("log2(TMB nonsilent)")+
  theme(legend.position = "none", strip.text.y = element_blank(), axis.title.x = element_blank(),
        strip.background = element_rect(fill = "white", colour = "black"),
        axis.text.x = element_text(angle = 45, hjust =1))+
  facet_grid(cols = vars(Project), rows = vars(parameter_name), scales = "free", space = "free")+
    stat_pvalue_manual(stat.test %>%
  filter(parameter_name == "TMB_nonsilent"),  label = "p.adj", tip.length = 0)


aneup_plot_df <- mutation_burden%>%
  ungroup() %>%
  filter(parameter_name == "Aneuploidy_Score")
ov_aneup_count <- msi_plot_df %>%
  filter(Project == "OV") %>%
  dplyr::select(Project, Methylation, Methylation_N) %>%
  distinct() %>%
  mutate(Methylation_N = "N=0")


aneup_plot <- aneup_plot_df  %>%
  dplyr::select(Methylation, Sample.ID, value, parameter_name, Methylation_N, Project) %>%
  distinct() %>%
  ggplot(aes(x = Methylation, y = value, color =Methylation))+
  geom_point(position = position_jitterdodge(jitter.width = 1), size = 0.8)+
  geom_boxplot(outlier.shape = NA, data = . %>% ungroup()%>% group_by(Project, Methylation, .keep = T) %>%
                 filter(n() >2) %>% ungroup() , alpha = 0)+
   geom_text(data = rbind(aneup_plot_df  %>%
              dplyr::select(Project, Methylation, Methylation_N) %>%
              distinct(),  ov_aneup_count), mapping = aes( y =-0.5, label = Methylation_N), color = "black", size = 2.5)+
  theme_bw()+
  scale_color_manual(values= methylation_color_extended, limits = force)+
  scale_y_continuous("Aneuploidy Score")+
  theme(legend.position = "none", strip.text.y = element_blank(), axis.title.x = element_blank(),
        strip.background = element_rect(fill = "white", colour = "black"),
        axis.text.x = element_text(angle = 45, hjust =1))+
  facet_grid(cols = vars(Project), rows = vars(parameter_name), scales = "free", space = "free")+
    stat_pvalue_manual(stat.test %>%
  filter(parameter_name == "Aneuploidy_Score"),  label = "p.adj", tip.length = 0)


ggarrange(msi_plot, tmb_plot, aneup_plot, common.legend = T, legend = "bottom", nrow =3, align = "v")
ggsave("plots/Supplementary/Sup6_mutation_burden.pdf", device = "pdf", height = 11, width = 16)
```
###In house annotation
```{r}

# mutation_depmap <- Sys.glob("data/raw/DEPMAP/MAFs/*gpc.maf.gz") %>%
#   map_dfr(~fread(cmd = paste0("gunzip -cq ", .x), skip = "Hugo_Symbol") %>%
#             mutate(Sample.ID =.x,
#                    ALT = if_else(Tumor_Seq_Allele1 ==Reference_Allele, Tumor_Seq_Allele2, Tumor_Seq_Allele1),
#                     `#Uploaded_variation` = paste0(Chromosome,"_", Start_Position,"_",Reference_Allele, "/",ALT)) %>%
#             filter(Hugo_Symbol != "unknown") %>%
#   separate(Sample.ID, into = c("id_1", "Sample.ID", "id_2"), extra = "drop", sep = "\\.") %>%
#     dplyr::select(-id_1, -id_2) %>%
#     separate(Sample.ID, into = c("Sample.ID"), extra = "drop", sep = "_"))%>%
#   mutate(silent_mutation = if_else((Effect_Ontology %in% 
#                                      c("5_prime_UTR_variant", "3_prime_UTR_variant", "synonymous_variant", "intron_variant", "intergenic_region") |
#                                        Variant_Classification %in% c("3'Flank", "5'Flank")), "Yes", "No"))
# 
# mutation_depmap %<>%
#    separate(Matched_Norm_Sample_Barcode, into = c("analysisID", "Sample.ID"), extra = "drop", sep = ":") %>%
#   mutate(Sample.ID = gsub("_wxs", "", Sample.ID)) %>%
#     dplyr::select(Hugo_Symbol, Sample.ID, HGVSc = CDS_Change, HGVSp =Amino_Acid_Change, silent_mutation, starts_with("N_"), starts_with("T_"), `#Uploaded_variation`) %>%
#   filter(Hugo_Symbol %in% c(gene_list,hr_gene_list)) %>%
#   distinct()
# 
# 
# mutation_depmap %>%
#   left_join(cell_ancestry %>%
#               dplyr::select(Sample.ID = CCLE_ID, inferred_ethnicity))
# 
# 
# depmap_clinvar <-  as.data.frame(fread("data/processed/VCF/depmap_variants_hg19.vcf.vep102.tsv",skip = "#Uploaded_variation", header = T, sep = "\t", na.string = "-"))%>%
#      select(1:3,5,7:8,
#            # Add symbol
#            SYMBOL,
#            EXON,
#            matches("HGVS(c|p)"),
#            matches("^gnomADe_non_cancer_(AC$|AF$|AN$|nhomalt$|faf95$)"),
#            matches("^gnomADe_non_cancer_(AC|AF|AN|nhomalt|faf95).*(eas$|sas$)"),
#            matches("^1000Gp1_(AC$|AF$)"),
#            matches("^1000Gp1_ASN_(AC$|AF$)"),
#            matches("^ClinVar", ignore.case = F))
# 
# depmap_clinvar <- mutation_depmap %>%
#   left_join(depmap_clinvar %>%
#               dplyr::select(-HGVSp, -HGVSc, Hugo_Symbol =SYMBOL ))%>%
#   filter( is.na(gnomADe_non_cancer_AC) | gnomADe_non_cancer_AC_eas <=10 | gnomADe_non_cancer_AC_sas <=10 )%>%
#   filter(is.na(gnomADe_non_cancer_faf95_eas)| is.na(gnomADe_non_cancer_faf95_sas)| gnomADe_non_cancer_faf95_eas <= 0.0001 | gnomADe_non_cancer_faf95_sas <= 0.0001) %>%
#   dplyr::select(-Feature, -EXON, -cDNA_position, -Consequence) %>%
#   distinct() %>%
#   filter(Hugo_Symbol  %in% c(hr_gene_list, "PIK3CA", "ARID1A", "TP53"))
# 
# 
# depmap_clinvar_mat <- depmap_clinvar%>%
#   mutate(mutation = if_else(str_detect(ClinVar_CLNSIG, fixed("Pathogenic", ignore_case = T))
#                             & !(str_detect(ClinVar_CLNSIG, fixed("Conflicting" , ignore_case = T)))
#                             & !is.na(ClinVar_CLNSIG), "Variants;Conseq", "Variants")) %>%
#   dplyr::select(Sample.ID, Hugo_Symbol, mutation) %>%
#   distinct() %>%
#   pivot_wider(names_from = Hugo_Symbol, values_from = mutation)
# 
# depmap_clinvar_mat[hr_gene_list[which(!hr_gene_list %in% colnames(depmap_clinvar_mat))]] = NA
# depmap_clinvar_mat["ARID1A"] = NA

```
```{r}
depmap_cimp <- fread("data/processed/depmap_brett/Global_methylation_beta_val_clustering.csv") %>%
  dplyr::select(Cell_Line, Cluster, Group) %>%
  mutate(Cell_Line = if_else(str_detect(Cell_Line, "^X[0-9]"), gsub("^X", "",Cell_Line), Cell_Line))
rad51c_depmap <- fread("data/processed/depmap_brett/RAD51C_clusters_methylation_STAD.csv", header =T) %>%
  gather(key = position, value = methylation, -V1, -level) %>%
  group_by(V1, level) %>%
  summarise(avg_meth = mean(methylation)) %>%
  ungroup() %>%
  mutate(level = case_when(level == "heterozygous" ~ "Heterozygous RAD51Cme",
                           level == "homozygous" ~ "Homozygous RAD51Cme",
                           level == "no methylation" ~"No Methylation")) %>%
  dplyr::rename(Sample.ID =V1) 


depmap_hrd <- Sys.glob("../test/hrd_stad_array/*.txt") %>%
  map_dfr(~ fread(.x)) %>%
  dplyr::rename(Sample.ID = V1) %>%
  mutate(Sample.ID = gsub("_STOMACH", "", Sample.ID))

rad51c_depmap %<>%
  left_join(depmap_cimp %>%
              dplyr::select(Sample.ID = Cell_Line, CIMP = Group)) %>%
  left_join(depmap_clinvar_mat %>%
              mutate(Sample.ID = gsub("_STOMACH", "", Sample.ID))) %>%
  left_join(depmap_hrd %>%
              dplyr::select(Sample.ID, HRD_Score = `HRD-sum`)) %>%
  mutate(CIMP = if_else(CIMP == "hypermethylated", "CIMP+", "CIMP-"))


avg_meth <- colorRamp2(breaks = c(0, 0.5, 1), colors = c("#0C7BDC", "white", "firebrick3"))

rad51c_depmap_mat <- rad51c_depmap %>%
  mutate(level = factor(level, levels = c("Homozygous RAD51Cme", "Heterozygous RAD51Cme","No Methylation"))) %>%
  arrange(level, CIMP, -HRD_Score) %>%
  # filter(level !=  "no methylation") %>%
  column_to_rownames("Sample.ID") %>%
  t()


plot <- oncoPrint(rad51c_depmap_mat[c(hr_gene_list, "TP53", "PIK3CA", "ARID1A"),],
  alter_fun = alter_fun,
  show_pct = FALSE,
  show_column_names = T,
  row_names_side = "left",
  row_order = 1:nrow(rad51c_depmap_mat[c(hr_gene_list, "TP53", "PIK3CA", "ARID1A"),]),
  column_order = 1:ncol(rad51c_depmap_mat[c(hr_gene_list, "TP53", "PIK3CA", "ARID1A"),]),
top_annotation =HeatmapAnnotation(
     `RAD51Cme Status`= rad51c_depmap_mat["level",],
       CIMP = rad51c_depmap_mat["CIMP",],
     `HRD Score` = anno_points(as.numeric(rad51c_depmap_mat["HRD_Score",]),simple_anno_size = unit(2, "cm"), ylim = c(0,100)),
     col = list(`RAD51Cme Status` = RAD51C_het_hom,
                `HRD Score`=HRD_color,
                CIMP = col$CIMP),gp = gpar(col = "white"),annotation_name_side = "left", annotation_name_rot = 0,
    annotation_name_gp = gpar(fontsize= 10)))


pdf("plots/Supplementary/Sup6_depmap_onco.pdf", height = 6, width =12)
draw(plot ,heatmap_legend_side = "bottom", annotation_legend_side = "bottom", merge_legend = TRUE )
decorate_annotation("HRD Score", {
 grid.lines(seq(0.5, ncol(rad51c_depmap_mat)+1), c(42, 42), default.units = "native", gp = gpar(lty = 3,lwd=1))
})
dev.off()
```

# deduplicate stats
```{r}
Deduplicated_beta %>%
  filter(Sample_Group %in% c("Primary Tumor"), Sample_Name %in% Deduplicated_beta$Sample_Name) %>%
  dplyr::select(Project, Sample_Name, Sample_Group, Sample.ID) %>%
        distinct() %>%
   mutate( Sample_Group = gsub("Tumour", "Tumor", Sample_Group),
           CaseID = if_else(Project =="ICGC_OV", substr(start = 1,stop = 8, Sample.ID), substr(start = 1,stop = 12, Sample.ID) )) %>%
  left_join( rbind(map_dfr(Sys.glob("data/raw/*/*clinical.tsv"), ~ as.data.frame(fread(.x, header = T, na.strings = "'--", fill = T,  colClasses = "character"))) %>%
               mutate(age = as.numeric(age_at_index)) %>%
                dplyr::select(stage = ajcc_pathologic_stage, gender, race, age, CaseID=case_submitter_id),
 fread("/working/lab_nicw/lijunX/20220505_ICGC_OV_meth/Patch_2015_ICGC_donor.tsv") %>%
  mutate(CaseID = gsub("-", "_", submitted_donor_id,),
         race = "not reported",
         stage = paste("Stage", donor_tumour_stage_at_diagnosis, sep = " ")) %>%
  dplyr::select(stage, gender= donor_sex, race, age = donor_age_at_diagnosis, CaseID)), by = "CaseID")%>%
  mutate(race = if_else(Project == "ICGC_OV", "not reported", race),
         stage = if_else(is.na(stage), "not reported", stage)) %>%
    distinct()-> demograph_table
  
                
write.csv(demograph_table, "data/processed/demograph_table.csv", quote = F, row.names = F)


meth_list <- fread("data/processed/TCGA_ICGC_methylation_list.tsv") %>%
  filter(Methylation != "No") %>%
  mutate(CaseID =if_else(Project =="OV", substr(start = 1,stop = 8, Sample.ID), substr(start = 1,stop = 12, Sample.ID))) %>%
  dplyr::select(-Sample.ID,- Project)
demograph_table %>%
  right_join(meth_list) -> demograph_table_meth


write.csv(demograph_table_meth, "data/processed/demograph_table_meth.csv", quote = F, row.names = F)

```
